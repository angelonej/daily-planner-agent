# Nginx reverse proxy config for Daily Planner Agent
# Place at: /etc/nginx/sites-available/planner
#
# For HTTP only (before Certbot):
#   sudo ln -s /etc/nginx/sites-available/planner /etc/nginx/sites-enabled/
#   sudo nginx -t && sudo systemctl reload nginx
#
# For HTTPS (after getting a domain):
#   sudo certbot --nginx -d yourdomain.com

server {
    listen 80;
    server_name _;   # replace _ with your domain or EC2 public IP

    # Security headers
    add_header X-Frame-Options DENY;
    add_header X-Content-Type-Options nosniff;
    add_header X-XSS-Protection "1; mode=block";

    # ── Optional: password-protect the whole app ──────────────────────────
    # Uncomment these two lines after running:
    #   sudo apt-get install -y apache2-utils
    #   sudo htpasswd -c /etc/nginx/.htpasswd yourname
    # auth_basic "Daily Planner";
    # auth_basic_user_file /etc/nginx/.htpasswd;

    # ── SSE endpoint: disable buffering so notifications stream instantly ──
    location /notifications {
        proxy_pass         http://127.0.0.1:3000;
        proxy_http_version 1.1;
        proxy_set_header   Host              $host;
        proxy_set_header   X-Real-IP         $remote_addr;
        proxy_set_header   X-Forwarded-For   $proxy_add_x_forwarded_for;
        proxy_set_header   X-Forwarded-Proto $scheme;
        proxy_set_header   Connection        '';
        proxy_buffering    off;
        proxy_cache        off;
        proxy_read_timeout 86400s;   # keep SSE alive for 24h
        chunked_transfer_encoding on;
    }

    # ── Main app proxy ─────────────────────────────────────────────────────
    location / {
        proxy_pass         http://127.0.0.1:3000;
        proxy_http_version 1.1;

        proxy_set_header   Host              $host;
        proxy_set_header   X-Real-IP         $remote_addr;
        proxy_set_header   X-Forwarded-For   $proxy_add_x_forwarded_for;
        proxy_set_header   X-Forwarded-Proto $scheme;
        proxy_set_header   Upgrade           $http_upgrade;
        proxy_set_header   Connection        'upgrade';

        # Needed for Twilio signature validation
        proxy_set_header   X-Twilio-Signature $http_x_twilio_signature;

        # Timeouts
        proxy_read_timeout  30s;
        proxy_connect_timeout 10s;

        proxy_buffering off;
    }

    # Health check endpoint (no auth required)
    location /health {
        proxy_pass http://127.0.0.1:3000/health;
        access_log off;
        # auth_basic off;  # uncomment if you enable auth_basic above
    }
}

# HTTPS block added automatically by Certbot — do not edit manually
