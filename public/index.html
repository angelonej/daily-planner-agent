<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Daily Planner Agent</title>
  <style>
    * { box-sizing: border-box; margin: 0; padding: 0; }

    body {
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      background: #0f1117;
      color: #e1e4e8;
      height: 100vh;
      height: 100dvh; /* mobile: excludes browser chrome */
      max-height: 100vh;
      max-height: 100dvh;
      overflow: hidden;
      display: flex;
      flex-direction: column;
    }

    html { height: 100%; overflow: hidden; }

    header {
      padding: 14px 20px;
      background: #161b22;
      border-bottom: 1px solid #30363d;
      display: flex;
      align-items: center;
      gap: 10px;
    }
    header h1 { font-size: 18px; font-weight: 600; }
    header .dot { width: 9px; height: 9px; border-radius: 50%; background: #3fb950; }

    #chat {
      flex: 1;
      overflow-y: auto;
      padding: 20px;
      display: flex;
      flex-direction: column;
      gap: 12px;
    }

    .bubble {
      max-width: 75%;
      padding: 10px 14px;
      border-radius: 16px;
      line-height: 1.5;
      font-size: 14px;
      white-space: pre-wrap;
      word-break: break-word;
    }
    .bubble.user {
      background: #1f6feb;
      align-self: flex-end;
      border-bottom-right-radius: 4px;
    }
    .bubble.agent {
      background: #21262d;
      border: 1px solid #30363d;
      align-self: flex-start;
      border-bottom-left-radius: 4px;
    }
    .bubble.system {
      background: transparent;
      border: 1px dashed #30363d;
      color: #8b949e;
      font-size: 12px;
      align-self: center;
      max-width: 90%;
      text-align: center;
    }
    .bubble a {
      color: #58a6ff;
      text-decoration: underline;
    }
    .bubble a:hover { color: #79c0ff; }

    .bubble.thinking {
      background: #21262d;
      border: 1px solid #30363d;
      align-self: flex-start;
      color: #8b949e;
      font-size: 13px;
      border-bottom-left-radius: 4px;
    }
    .dots span {
      animation: blink 1.2s infinite;
    }
    .dots span:nth-child(2) { animation-delay: 0.2s; }
    .dots span:nth-child(3) { animation-delay: 0.4s; }
    @keyframes blink { 0%,80%,100% { opacity: 0.2; } 40% { opacity: 1; } }

    .label {
      font-size: 11px;
      color: #8b949e;
      margin-bottom: 2px;
      padding: 0 4px;
    }
    .label.right { text-align: right; }

    /* ‚îÄ‚îÄ Bottom input bar ‚îÄ‚îÄ */
    footer {
      padding: 10px 12px;
      padding-bottom: max(10px, env(safe-area-inset-bottom));
      background: #161b22;
      border-top: 1px solid #30363d;
      display: flex;
      align-items: center;
      gap: 8px;
      z-index: 100;
    }

    #textInput {
      flex: 1;
      background: #21262d;
      border: 1px solid #30363d;
      border-radius: 22px;
      color: #e1e4e8;
      padding: 11px 16px;
      font-size: 16px;
      outline: none;
      transition: border-color 0.2s;
      min-width: 0;
    }
    #textInput:focus { border-color: #1f6feb; }
    #textInput::placeholder { color: #484f58; }

    button {
      border: none;
      border-radius: 50%;
      cursor: pointer;
      font-size: 18px;
      font-weight: 600;
      transition: opacity 0.15s, transform 0.1s, background 0.15s;
      flex-shrink: 0;
      width: 44px;
      height: 44px;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 0;
    }
    button:active { transform: scale(0.92); }
    button:disabled { opacity: 0.4; cursor: not-allowed; }

    #sendBtn {
      background: #1f6feb;
      color: #fff;
      font-size: 20px;
    }
    #menuBtn {
      background: #21262d;
      border: 1px solid #30363d;
      color: #e1e4e8;
      font-size: 20px;
      position: relative;
    }
    #menuBtn.open { background: #30363d; }

    /* ‚îÄ‚îÄ Slide-up drawer ‚îÄ‚îÄ */
    #drawer-overlay {
      display: none;
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.5);
      z-index: 200;
      backdrop-filter: blur(2px);
    }
    #drawer-overlay.open { display: block; }

    #drawer {
      position: fixed;
      bottom: 0;
      left: 0;
      right: 0;
      background: #161b22;
      border-top: 1px solid #30363d;
      border-radius: 20px 20px 0 0;
      z-index: 201;
      padding: 12px 16px 24px;
      padding-bottom: max(24px, env(safe-area-inset-bottom));
      transform: translateY(100%);
      transition: transform 0.3s cubic-bezier(0.32, 0.72, 0, 1);
    }
    #drawer.open { transform: translateY(0); }

    .drawer-handle {
      width: 36px;
      height: 4px;
      background: #30363d;
      border-radius: 2px;
      margin: 0 auto 16px;
    }

    .drawer-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 10px;
    }

    .drawer-btn {
      width: 100% !important;
      height: 56px !important;
      border-radius: 14px !important;
      font-size: 14px !important;
      font-weight: 600;
      display: flex !important;
      flex-direction: column;
      align-items: center !important;
      justify-content: center !important;
      gap: 4px;
      color: #fff;
    }
    .drawer-btn .btn-icon { font-size: 20px; line-height: 1; }
    .drawer-btn .btn-label { font-size: 11px; opacity: 0.85; }

    #morningBtn  { background: #1a6334; }
    #digestBtn   { background: #4a2b8a; }
    #recurringBtn{ background: #0e5a6e; }
    #clearBtn    { background: #2a1f1f; border: 1px solid #6e1a1a !important; }
    #clearBtn .btn-label { color: #f85149; }

    /* Notification + stop row */
    .drawer-row {
      display: flex;
      gap: 10px;
      margin-top: 10px;
    }
    .drawer-row-btn {
      flex: 1;
      height: 44px !important;
      border-radius: 12px !important;
      font-size: 13px !important;
      font-weight: 600;
      display: flex !important;
      align-items: center !important;
      justify-content: center !important;
      gap: 6px;
      width: auto !important;
    }

    #notifBtn {
      background: #21262d;
      border: 1px solid #30363d !important;
      color: #e1e4e8;
      position: relative;
    }
    #notifBtn.active { border-color: #3fb950 !important; color: #3fb950; }
    #notifBadge {
      display: none;
      position: absolute;
      top: -4px;
      right: -4px;
      background: #da3633;
      color: #fff;
      font-size: 10px;
      font-weight: bold;
      border-radius: 50%;
      width: 16px;
      height: 16px;
      line-height: 16px;
      text-align: center;
    }
    #stopBtn {
      background: #3d1f1f;
      border: 1px solid #6e1a1a !important;
      color: #f85149;
    }

    /* Notification toast */
    #toastContainer {
      position: fixed;
      top: 16px;
      right: 16px;
      z-index: 9999;
      display: flex;
      flex-direction: column;
      gap: 8px;
      pointer-events: none;
    }
    .toast {
      background: #1c2128;
      border: 1px solid #30363d;
      border-left: 4px solid #3fb950;
      border-radius: 8px;
      padding: 12px 16px;
      max-width: 320px;
      box-shadow: 0 4px 16px rgba(0,0,0,0.5);
      animation: slideIn 0.3s ease;
      pointer-events: all;
    }
    .toast.urgent { border-left-color: #da3633; }
    .toast-title { font-weight: 600; font-size: 14px; color: #e1e4e8; }
    .toast-body  { font-size: 13px; color: #8b949e; margin-top: 2px; }
    @keyframes slideIn { from { transform: translateX(110%); opacity:0; } to { transform: translateX(0); opacity:1; } }
    @keyframes slideOut { to { transform: translateX(110%); opacity:0; } }

    #micBtn {
      background: #21262d;
      border: 1px solid #30363d;
      color: #e1e4e8;
      font-size: 22px;
      transition: background 0.15s, border-color 0.15s, box-shadow 0.15s;
      user-select: none;
      -webkit-user-select: none;
    }
    #micBtn.recording {
      background: #da3633;
      border-color: #da3633;
      box-shadow: 0 0 0 6px rgba(218,54,51,0.25);
      animation: pulse 1s infinite;
    }
    @keyframes pulse { 0%,100%{box-shadow:0 0 0 4px rgba(218,54,51,0.25)} 50%{box-shadow:0 0 0 10px rgba(218,54,51,0.1)} }

    #voiceStatus {
      display: none; /* shown in drawer only */
    }

    #audioPlayer { display: none; }
    .transcript-tag { display: none; }

    /* ‚îÄ‚îÄ Mobile responsive ‚îÄ‚îÄ */
    @media (max-width: 600px) {
      header { padding: 10px 14px; }
      header h1 { font-size: 15px; }
      #chat { padding: 12px; gap: 10px; }
      .bubble { max-width: 90%; }
      #toastContainer {
        top: auto;
        bottom: 80px;
        right: 8px;
        left: 8px;
      }
      .toast { max-width: 100%; }
    }
  </style>
</head>
<body>

<div id="toastContainer"></div>

<header>
  <div class="dot"></div>
  <h1>ü§ñ Daily Planner Agent</h1>
</header>

<div id="chat">
  <div class="bubble system">
    Say hello, ask about your calendar, or press ‚òÄÔ∏è for your morning briefing.<br/>
    Hold üéô to speak, or type below.
  </div>
</div>

<!-- Slide-up drawer overlay -->
<div id="drawer-overlay"></div>
<div id="drawer">
  <div class="drawer-handle"></div>
  <div class="drawer-grid">
    <button id="morningBtn" class="drawer-btn">
      <span class="btn-icon">‚òÄÔ∏è</span><span class="btn-label">Morning Briefing</span>
    </button>
    <button id="digestBtn" class="drawer-btn">
      <span class="btn-icon">üìß</span><span class="btn-label">Email Digest</span>
    </button>
    <button id="recurringBtn" class="drawer-btn">
      <span class="btn-icon">üîÑ</span><span class="btn-label">Recurring Events</span>
    </button>
    <button id="clearBtn" class="drawer-btn">
      <span class="btn-icon">üóë</span><span class="btn-label">Clear Chat</span>
    </button>
  </div>
  <div class="drawer-row">
    <button id="notifBtn" class="drawer-row-btn">üîî Notifications<span id="notifBadge"></span></button>
    <button id="stopBtn" class="drawer-row-btn">‚èπ Stop Speaking</button>
  </div>
  <div style="margin-top:12px; font-size:12px; color:#484f58; text-align:center;">
    <span id="voiceStatus">Tap üéô to speak</span>
  </div>
</div>

<footer>
  <button id="menuBtn" title="Open menu">‚ãØ</button>
  <input id="textInput" type="text" placeholder='Message your planner‚Ä¶' autocomplete="off" />
  <button id="micBtn" title="Tap to speak">üéô</button>
  <button id="sendBtn" title="Send">‚û§</button>
</footer>

<script>
  const chat        = document.getElementById('chat');
  const textInput   = document.getElementById('textInput');
  const sendBtn     = document.getElementById('sendBtn');
  const menuBtn     = document.getElementById('menuBtn');
  const morningBtn  = document.getElementById('morningBtn');
  const digestBtn   = document.getElementById('digestBtn');
  const recurringBtn= document.getElementById('recurringBtn');
  const clearBtn    = document.getElementById('clearBtn');
  const notifBtn    = document.getElementById('notifBtn');
  const notifBadge  = document.getElementById('notifBadge');
  const micBtn      = document.getElementById('micBtn');
  const stopBtn     = document.getElementById('stopBtn');
  const voiceStatus = document.getElementById('voiceStatus');
  const toastContainer = document.getElementById('toastContainer');
  const drawer      = document.getElementById('drawer');
  const drawerOverlay = document.getElementById('drawer-overlay');

  function openDrawer()  { drawer.classList.add('open'); drawerOverlay.classList.add('open'); menuBtn.classList.add('open'); }
  function closeDrawer() { drawer.classList.remove('open'); drawerOverlay.classList.remove('open'); menuBtn.classList.remove('open'); }
  menuBtn.addEventListener('click', () => drawer.classList.contains('open') ? closeDrawer() : openDrawer());
  drawerOverlay.addEventListener('click', closeDrawer);
  // Close drawer when any drawer button is tapped
  drawer.querySelectorAll('button').forEach(b => b.addEventListener('click', () => setTimeout(closeDrawer, 150)));

  const USER_ID = 'web-user';
  let unreadNotifs = 0;

  // ‚îÄ‚îÄ Toast notifications ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  function showToast(title, body, urgent = false) {
    const toast = document.createElement('div');
    toast.className = 'toast' + (urgent ? ' urgent' : '');
    toast.innerHTML = `<div class="toast-title">${title}</div><div class="toast-body">${body}</div>`;
    toastContainer.appendChild(toast);
    // Also show browser notification if permission granted
    if (Notification.permission === 'granted') {
      new Notification(title, { body, icon: '/favicon.ico' });
    }
    // Badge count
    unreadNotifs++;
    notifBadge.style.display = 'block';
    notifBadge.textContent = unreadNotifs > 9 ? '9+' : unreadNotifs;
    // Auto-remove after 6 seconds
    setTimeout(() => {
      toast.style.animation = 'slideOut 0.3s ease forwards';
      setTimeout(() => toast.remove(), 300);
    }, 6000);
  }

  // ‚îÄ‚îÄ SSE: listen for server-push notifications ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  function connectSSE() {
    const es = new EventSource('/notifications');
    es.addEventListener('notification', (e) => {
      try {
        const alert = JSON.parse(e.data);
        const urgent = alert.type === 'event_starting';
        showToast(alert.title, alert.body, urgent);
      } catch {}
    });
    es.addEventListener('error', () => {
      // Reconnect after 5s on error
      es.close();
      setTimeout(connectSSE, 5000);
    });
  }
  connectSSE();

  // ‚îÄ‚îÄ Notification bell: request browser permission ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  notifBtn.addEventListener('click', async () => {
    // Clear badge
    unreadNotifs = 0;
    notifBadge.style.display = 'none';

    if (Notification.permission === 'granted') {
      notifBtn.classList.add('active');
      showToast('üîî Notifications', 'Browser notifications are already enabled!');
      return;
    }
    if (Notification.permission === 'denied') {
      showToast('üîï Blocked', 'Browser notifications are blocked. Enable them in browser settings.');
      return;
    }
    const perm = await Notification.requestPermission();
    if (perm === 'granted') {
      notifBtn.classList.add('active');
      showToast('üîî Notifications enabled', 'You will get alerts for upcoming events!');
    }
  });

  // Auto-check permission on load
  if (Notification.permission === 'granted') notifBtn.classList.add('active');

  // ‚îÄ‚îÄ Web Speech API setup ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
  let recognition = null;
  let isListening = false;

  if (SpeechRecognition) {
    recognition = new SpeechRecognition();
    recognition.lang = 'en-US';
    recognition.interimResults = true;
    recognition.continuous = false;

    recognition.onresult = (event) => {
      const results = Array.from(event.results);
      const transcript = results.map(r => r[0].transcript).join('');
      if (event.results[event.results.length - 1].isFinal) {
        voiceStatus.textContent = '‚è≥ Sending‚Ä¶';
        sendText(transcript);
      } else {
        voiceStatus.textContent = 'üéô "' + transcript + '"';
      }
    };

    recognition.onerror = (e) => {
      if (e.error === 'not-allowed') {
        const isHttp = location.protocol === 'http:';
        voiceStatus.textContent = isHttp
          ? '‚ö†Ô∏è Mic blocked ‚Äî browser requires HTTPS for microphone access. Use the text input below.'
          : '‚ö†Ô∏è Mic permission denied ‚Äî tap mic again and allow access.';
      } else {
        voiceStatus.textContent = '‚ö†Ô∏è Speech error: ' + e.error;
      }
      micBtn.classList.remove('recording');
      isListening = false;
    };

    recognition.onend = () => {
      micBtn.classList.remove('recording');
      isListening = false;
      voiceStatus.textContent = 'Click the mic button to speak';
    };
  } else {
    voiceStatus.textContent = '‚ö†Ô∏è Voice not supported in this browser (use Chrome)';
    micBtn.disabled = true;
  }

  // Warn immediately if on HTTP (mic won't work)
  if (location.protocol === 'http:' && SpeechRecognition) {
    voiceStatus.textContent = '‚ö†Ô∏è Mic unavailable over HTTP ‚Äî use the text input to chat';
    micBtn.title = 'Microphone requires HTTPS';
  }

  // ‚îÄ‚îÄ Stop button: cancel TTS and mic ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  stopBtn.addEventListener('click', () => {
    window.speechSynthesis?.cancel();
    if (isListening && recognition) {
      recognition.stop();
      isListening = false;
      micBtn.classList.remove('recording');
    }
    voiceStatus.textContent = 'Stopped.';
    setTimeout(() => { voiceStatus.textContent = 'Click the mic button to speak'; }, 1500);
  });

  // ‚îÄ‚îÄ helpers ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

  // Convert a small subset of markdown to HTML (links, bold, code)
  function renderMarkdown(text) {
    // Extract [label](url) links BEFORE any escaping so URLs aren't corrupted
    const linkPlaceholders = [];
    let processed = text.replace(/\[([^\]]+)\]\((https?:\/\/[^)]+)\)/g, (_, label, url) => {
      const idx = linkPlaceholders.length;
      linkPlaceholders.push(`<a href="${url}" target="_blank" rel="noopener">${escapeHtml(label)}</a>`);
      return `\x00LINK${idx}\x00`;
    });
    // Now escape HTML in the rest of the text
    processed = escapeHtml(processed);
    // Re-insert the links (already safe HTML)
    processed = processed.replace(/\x00LINK(\d+)\x00/g, (_, i) => linkPlaceholders[+i]);
    // **bold**
    processed = processed.replace(/\*\*([^*]+)\*\*/g, '<strong>$1</strong>');
    // `code`
    processed = processed.replace(/`([^`]+)`/g, '<code style="background:#161b22;padding:1px 5px;border-radius:4px;font-size:0.9em">$1</code>');
    // newlines ‚Üí <br>
    processed = processed.replace(/\n/g, '<br>');
    return processed;
  }

  function escapeHtml(str) {
    return str
      .replace(/&/g, '&amp;')
      .replace(/</g, '&lt;')
      .replace(/>/g, '&gt;');
  }

  // Strip markdown for TTS (remove links, bold markers, etc.)
  function stripMarkdown(text) {
    return text
      .replace(/\[([^\]]+)\]\([^)]+\)/g, '$1') // [label](url) ‚Üí label
      .replace(/\*\*([^*]+)\*\*/g, '$1')        // **bold** ‚Üí bold
      .replace(/`([^`]+)`/g, '$1');              // `code` ‚Üí code
  }

  function addBubble(role, text) {
    const wrap = document.createElement('div');

    const label = document.createElement('div');
    label.className = 'label' + (role === 'user' ? ' right' : '');
    label.textContent = role === 'user' ? 'You' : 'Assistant';
    wrap.appendChild(label);

    const bubble = document.createElement('div');
    bubble.className = 'bubble ' + role;
    if (role === 'agent') {
      bubble.innerHTML = renderMarkdown(text);
    } else {
      bubble.textContent = text;
    }
    wrap.appendChild(bubble);

    chat.appendChild(wrap);
    chat.scrollTop = chat.scrollHeight;
    return bubble;
  }

  function addThinking() {
    const wrap = document.createElement('div');
    const label = document.createElement('div');
    label.className = 'label';
    label.textContent = 'Assistant';
    wrap.appendChild(label);
    const bubble = document.createElement('div');
    bubble.className = 'bubble thinking';
    bubble.innerHTML = '<span class="dots"><span>‚óè</span><span>‚óè</span><span>‚óè</span></span>';
    wrap.appendChild(bubble);
    chat.appendChild(wrap);
    chat.scrollTop = chat.scrollHeight;
    return wrap;
  }

  function setButtons(disabled) {
    sendBtn.disabled = disabled;
    morningBtn.disabled = disabled;
    digestBtn.disabled = disabled;
    recurringBtn.disabled = disabled;
    micBtn.disabled = disabled;
  }

  // ‚îÄ‚îÄ Browser TTS (free, no API) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  function speakText(text) {
    if (!window.speechSynthesis) return;
    window.speechSynthesis.cancel(); // stop any current speech
    const utt = new SpeechSynthesisUtterance(text);
    utt.lang = 'en-US';
    utt.rate = 1.05;
    utt.pitch = 1;
    // Prefer a natural-sounding voice if available
    const voices = window.speechSynthesis.getVoices();
    const preferred = voices.find(v =>
      v.name.includes('Google US English') ||
      v.name.includes('Samantha') ||
      v.name.includes('Karen') ||
      (v.lang === 'en-US' && v.localService)
    );
    if (preferred) utt.voice = preferred;
    window.speechSynthesis.speak(utt);
  }

  // Voices load async ‚Äî preload them
  window.speechSynthesis?.getVoices();
  window.speechSynthesis?.addEventListener('voiceschanged', () => window.speechSynthesis.getVoices());

  // ‚îÄ‚îÄ text send ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  async function sendText(msg) {
    if (!msg.trim()) return;
    textInput.value = '';
    addBubble('user', msg);
    const thinking = addThinking();
    setButtons(true);

    try {
      const res = await fetch('/voice-chat', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ text: msg, userId: USER_ID }),
      });
      if (res.status === 401) {
        thinking.remove();
        addBubble('agent', 'üîí Session expired ‚Äî redirecting to login‚Ä¶');
        setTimeout(() => { window.location.href = '/login'; }, 1500);
        return;
      }
      const data = await res.json();
      thinking.remove();
      const reply = data.reply || data.error || 'No response';
      addBubble('agent', reply);
      speakText(stripMarkdown(reply));
    } catch (e) {
      thinking.remove();
      addBubble('agent', '‚ö†Ô∏è Network error: ' + e.message);
    } finally {
      setButtons(false);
      voiceStatus.textContent = 'Click the mic button to speak';
      textInput.focus();
    }
  }

  sendBtn.addEventListener('click', () => sendText(textInput.value));
  textInput.addEventListener('keydown', e => { if (e.key === 'Enter' && !e.shiftKey) sendText(textInput.value); });
  morningBtn.addEventListener('click', () => sendText('/morning'));
  digestBtn.addEventListener('click', async () => {
    setButtons(true);
    digestBtn.textContent = 'üìß Sending‚Ä¶';
    try {
      const res = await fetch('/send-digest', { method: 'POST' });
      const data = await res.json();
      if (data.ok) {
        showToast('üìß Digest sent!', `Morning briefing emailed successfully.`);
        addBubble('agent', '‚úÖ Morning digest email sent!');
      } else {
        addBubble('agent', `‚ùå Email failed: ${data.error}`);
      }
    } catch (e) {
      addBubble('agent', '‚ö†Ô∏è Could not send digest: ' + e.message);
    } finally {
      digestBtn.textContent = 'üìß Email Digest';
      setButtons(false);
    }
  });
  recurringBtn.addEventListener('click', () => sendText('analyze my calendar for recurring patterns'));
  clearBtn.addEventListener('click', async () => {
    window.speechSynthesis?.cancel();
    await fetch('/voice-chat', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ text: '/clear', userId: USER_ID }),
    });
    chat.innerHTML = '<div class="bubble system">Conversation cleared.</div>';
  });

  // ‚îÄ‚îÄ Mic button: click to toggle listening ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  micBtn.addEventListener('click', () => {
    if (!recognition) return;
    if (isListening) {
      recognition.stop();
      isListening = false;
      micBtn.classList.remove('recording');
      voiceStatus.textContent = 'Click the mic button to speak';
    } else {
      window.speechSynthesis?.cancel(); // stop TTS before listening
      recognition.start();
      isListening = true;
      micBtn.classList.add('recording');
      voiceStatus.textContent = 'üî¥ Listening‚Ä¶ speak now';
    }
  });
</script>

</body>
</html>
