<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Daily Planner Agent</title>
  <link rel="manifest" href="/manifest.json" />
  <style>
    * { box-sizing: border-box; margin: 0; padding: 0; }

    body {
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      background: #0f1117;
      color: #e1e4e8;
      height: 100vh;
      height: 100dvh; /* mobile: excludes browser chrome */
      max-height: 100vh;
      max-height: 100dvh;
      overflow: hidden;
      display: flex;
      flex-direction: column;
    }

    html { height: 100%; overflow: hidden; }

    header {
      padding: 14px 20px;
      background: #161b22;
      border-bottom: 1px solid #30363d;
      display: flex;
      align-items: center;
      gap: 10px;
    }
    header h1 { font-size: 18px; font-weight: 600; }
    header .dot { width: 9px; height: 9px; border-radius: 50%; background: #3fb950; }

    #chat {
      flex: 1;
      overflow-y: auto;
      padding: 20px;
      display: flex;
      flex-direction: column;
      gap: 12px;
    }

    .bubble {
      max-width: 75%;
      padding: 10px 14px;
      border-radius: 16px;
      line-height: 1.5;
      font-size: 14px;
      white-space: pre-wrap;
      word-break: break-word;
    }
    .bubble.user {
      background: #1f6feb;
      align-self: flex-end;
      border-bottom-right-radius: 4px;
    }
    .bubble.agent {
      background: #21262d;
      border: 1px solid #30363d;
      align-self: flex-start;
      border-bottom-left-radius: 4px;
    }
    .bubble.system {
      background: transparent;
      border: 1px dashed #30363d;
      color: #8b949e;
      font-size: 12px;
      align-self: center;
      max-width: 90%;
      text-align: center;
    }
    .bubble a {
      color: #58a6ff;
      text-decoration: underline;
    }
    .bubble a:hover { color: #79c0ff; }

    .bubble.thinking {
      background: #21262d;
      border: 1px solid #30363d;
      align-self: flex-start;
      color: #8b949e;
      font-size: 13px;
      border-bottom-left-radius: 4px;
    }
    .dots span {
      animation: blink 1.2s infinite;
    }
    .dots span:nth-child(2) { animation-delay: 0.2s; }
    .dots span:nth-child(3) { animation-delay: 0.4s; }
    @keyframes blink { 0%,80%,100% { opacity: 0.2; } 40% { opacity: 1; } }

    .label {
      font-size: 11px;
      color: #8b949e;
      margin-bottom: 2px;
      padding: 0 4px;
    }
    .label.right { text-align: right; }

    /* â”€â”€ Bottom input bar â”€â”€ */
    footer {
      padding: 10px 12px;
      padding-bottom: max(10px, env(safe-area-inset-bottom));
      background: #161b22;
      border-top: 1px solid #30363d;
      display: flex;
      align-items: center;
      gap: 8px;
      z-index: 100;
    }

    #textInput {
      flex: 1;
      background: #21262d;
      border: 1px solid #30363d;
      border-radius: 22px;
      color: #e1e4e8;
      padding: 11px 16px;
      font-size: 16px;
      outline: none;
      transition: border-color 0.2s;
      min-width: 0;
    }
    #textInput:focus { border-color: #1f6feb; }
    #textInput::placeholder { color: #484f58; }

    button {
      border: none;
      border-radius: 50%;
      cursor: pointer;
      font-size: 18px;
      font-weight: 600;
      transition: opacity 0.15s, transform 0.1s, background 0.15s;
      flex-shrink: 0;
      width: 44px;
      height: 44px;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 0;
    }
    button:active { transform: scale(0.92); }
    button:disabled { opacity: 0.4; cursor: not-allowed; }

    #sendBtn {
      background: #1f6feb;
      color: #fff;
      font-size: 20px;
    }
    #menuBtn {
      background: #21262d;
      border: 1px solid #30363d;
      color: #e1e4e8;
      font-size: 20px;
      position: relative;
    }
    #menuBtn.open { background: #30363d; }

    /* â”€â”€ Slide-up drawer â”€â”€ */
    #drawer-overlay {
      display: none;
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.5);
      z-index: 200;
      backdrop-filter: blur(2px);
    }
    #drawer-overlay.open { display: block; }

    #drawer {
      position: fixed;
      bottom: 0;
      left: 0;
      right: 0;
      background: #161b22;
      border-top: 1px solid #30363d;
      border-radius: 20px 20px 0 0;
      z-index: 201;
      padding: 12px 16px 24px;
      padding-bottom: max(24px, env(safe-area-inset-bottom));
      transform: translateY(100%);
      transition: transform 0.3s cubic-bezier(0.32, 0.72, 0, 1);
    }
    #drawer.open { transform: translateY(0); }

    .drawer-handle {
      width: 36px;
      height: 4px;
      background: #30363d;
      border-radius: 2px;
      margin: 0 auto 12px;
    }

    /* â”€â”€ Drawer tabs â”€â”€ */
    .drawer-tabs {
      display: flex;
      gap: 4px;
      margin-bottom: 12px;
      background: #0d1117;
      border-radius: 10px;
      padding: 3px;
    }
    .dtab {
      flex: 1;
      height: 32px;
      border-radius: 8px;
      font-size: 12px;
      font-weight: 600;
      background: none;
      border: none !important;
      color: #8b949e;
      cursor: pointer;
      transition: background .15s, color .15s;
      width: auto !important;
      border-radius: 8px !important;
    }
    .dtab.active { background: #21262d; color: #e1e4e8; }

    .drawer-panel { display: none; }
    .drawer-panel.active { display: block; }

    /* â”€â”€ Chip grid â”€â”€ */
    .chip-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 8px;
      margin-bottom: 10px;
    }
    .chip-btn {
      height: 52px !important;
      border-radius: 12px !important;
      font-size: 13px !important;
      font-weight: 600;
      display: flex !important;
      flex-direction: column;
      align-items: center !important;
      justify-content: center !important;
      gap: 3px;
      color: #e1e4e8;
      background: #21262d;
      border: 1px solid #30363d !important;
      width: 100% !important;
      transition: background .15s, border-color .15s;
    }
    .chip-btn:active { background: #30363d; }
    .chip-btn .ci { font-size: 18px; line-height: 1; }
    .chip-btn .cl { font-size: 10px; opacity: .8; }

    /* action section label */
    .section-label {
      font-size: 10px;
      font-weight: 700;
      color: #484f58;
      text-transform: uppercase;
      letter-spacing: .08em;
      margin: 8px 0 6px;
    }
    .section-label:first-child { margin-top: 0; }

    .drawer-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 8px;
    }

    .drawer-btn {
      width: 100% !important;
      height: 52px !important;
      border-radius: 12px !important;
      border: none !important;
      font-size: 13px !important;
      font-weight: 600;
      display: flex !important;
      flex-direction: column;
      align-items: center !important;
      justify-content: center !important;
      gap: 3px;
      color: #fff;
    }
    .drawer-btn .btn-icon { font-size: 18px; line-height: 1; }
    .drawer-btn .btn-label { font-size: 10px; opacity: 0.85; }

    #morningBtn  { background: #1a6334; }
    #digestBtn   { background: #4a2b8a; }
    #eveningBtn { background: #2d1f5e; }
    #clearBtn    { background: #2a1f1f; border: 1px solid #6e1a1a !important; }
    #clearBtn .btn-label { color: #f85149; }

    /* Notification + stop row */
    .drawer-row {
      display: flex;
      gap: 10px;
      margin-top: 10px;
    }
    .drawer-row-btn {
      flex: 1;
      height: 44px !important;
      border-radius: 12px !important;
      font-size: 13px !important;
      font-weight: 600;
      display: flex !important;
      align-items: center !important;
      justify-content: center !important;
      gap: 6px;
      width: auto !important;
    }

    #notifBtn {
      position: relative;
    }
    #notifBtn.active { outline: 2px solid #3fb950; color: #3fb950; }
    #notifBadge {
      display: none;
      position: absolute;
      top: -4px;
      right: -4px;
      background: #da3633;
      color: #fff;
      font-size: 10px;
      font-weight: bold;
      border-radius: 50%;
      width: 16px;
      height: 16px;
      line-height: 16px;
      text-align: center;
    }
    #stopBtn {
      background: #3d1f1f;
      border: 1px solid #6e1a1a !important;
      color: #f85149;
    }

    /* Notification toast */
    #toastContainer {
      position: fixed;
      top: 16px;
      right: 16px;
      z-index: 9999;
      display: flex;
      flex-direction: column;
      gap: 8px;
      pointer-events: none;
    }
    .toast {
      background: #1c2128;
      border: 1px solid #30363d;
      border-left: 4px solid #3fb950;
      border-radius: 8px;
      padding: 12px 16px;
      max-width: 320px;
      box-shadow: 0 4px 16px rgba(0,0,0,0.5);
      animation: slideIn 0.3s ease;
      pointer-events: all;
    }
    .toast.urgent { border-left-color: #da3633; }
    .toast-title { font-weight: 600; font-size: 14px; color: #e1e4e8; }
    .toast-body  { font-size: 13px; color: #8b949e; margin-top: 2px; }
    @keyframes slideIn { from { transform: translateX(110%); opacity:0; } to { transform: translateX(0); opacity:1; } }
    @keyframes slideOut { to { transform: translateX(110%); opacity:0; } }

    #micBtn {
      background: #21262d;
      border: 1px solid #30363d;
      color: #e1e4e8;
      font-size: 22px;
      transition: background 0.15s, border-color 0.15s, box-shadow 0.15s;
      user-select: none;
      -webkit-user-select: none;
    }
    #micBtn.recording {
      background: #da3633;
      border-color: #da3633;
      box-shadow: 0 0 0 6px rgba(218,54,51,0.25);
      animation: pulse 1s infinite;
    }
    @keyframes pulse { 0%,100%{box-shadow:0 0 0 4px rgba(218,54,51,0.25)} 50%{box-shadow:0 0 0 10px rgba(218,54,51,0.1)} }

    #voiceStatus {
      display: none; /* shown in drawer only */
    }

    #audioPlayer { display: none; }
    .transcript-tag { display: none; }

    /* â”€â”€ Mobile responsive â”€â”€ */
    @media (max-width: 600px) {
      header { padding: 10px 14px; }
      header h1 { font-size: 15px; }
      #chat { padding: 12px; gap: 10px; }
      .bubble { max-width: 90%; }
      #toastContainer {
        top: auto;
        bottom: 80px;
        right: 8px;
        left: 8px;
      }
      .toast { max-width: 100%; }
    }
  </style>
</head>
<body>

<div id="toastContainer"></div>

<header>
  <div class="dot"></div>
  <h1>ğŸ¤– Daily Planner Agent</h1>
</header>

<div id="chat">
  <div class="bubble system">
    Say hello, ask about your calendar, or press â˜€ï¸ for your morning briefing.<br/>
    Tap ğŸ™ to speak, or type below.
  </div>
</div>

<!-- Slide-up drawer overlay -->
<div id="drawer-overlay"></div>
<div id="drawer">
  <div class="drawer-handle"></div>

  <!-- Tabs -->
  <div class="drawer-tabs">
    <button class="dtab active" id="tab-actions" onclick="switchDrawerTab('actions')">âš¡ Actions</button>
    <button class="dtab" id="tab-ask" onclick="switchDrawerTab('ask')">ğŸ’¬ Ask</button>
    <button class="dtab" id="tab-tools" onclick="switchDrawerTab('tools')">ğŸ›  Tools</button>
  </div>

  <!-- Actions panel -->
  <div class="drawer-panel active" id="panel-actions">
    <div class="drawer-grid">
      <button id="morningBtn" class="drawer-btn">
        <span class="btn-icon">â˜€ï¸</span><span class="btn-label">Morning Briefing</span>
      </button>
      <button id="eveningBtn" class="drawer-btn">
        <span class="btn-icon">ğŸŒ™</span><span class="btn-label">Evening Briefing</span>
      </button>
      <button id="digestBtn" class="drawer-btn">
        <span class="btn-icon">ğŸ“§</span><span class="btn-label">Email Digest</span>
      </button>
      <button id="notifBtn" class="drawer-btn" style="background:#1a3a5c;">
        <span class="btn-icon">ğŸ””</span><span class="btn-label">Notifications<span id="notifBadge"></span></span>
      </button>
    </div>
    <div class="drawer-row">
      <button id="muteBtn" class="drawer-row-btn">ğŸ”Š Voice On</button>
      <button id="clearBtn" class="drawer-row-btn" style="background:#2a1f1f;border:1px solid #6e1a1a !important;color:#f85149;">ğŸ—‘ Clear Chat</button>
    </div>
    <div id="notif-history" style="display:none;padding:8px 0">
      <div style="font-size:11px;font-weight:700;color:var(--muted);text-transform:uppercase;letter-spacing:.05em;margin-bottom:6px">Recent Alerts</div>
      <div id="notif-history-list"><div style="font-size:12px;color:var(--muted);text-align:center;padding:12px 0">No notifications yet</div></div>
      <button onclick="document.getElementById('notif-history').style.display='none'" style="width:100%;margin-top:8px;padding:6px;background:var(--surface2);border:none;border-radius:6px;color:var(--muted);font-size:12px;cursor:pointer">Hide â–²</button>
    </div>
  </div>

  <!-- Quick Ask panel -->
  <div class="drawer-panel" id="panel-ask">
    <div class="section-label">ğŸ“… Calendar</div>
    <div class="chip-grid">
      <button class="chip-btn" onclick="quickAsk('What is on my calendar today?')"><span class="ci">ğŸ“…</span><span class="cl">Today</span></button>
      <button class="chip-btn" onclick="quickAsk('What is on my calendar this week?')"><span class="ci">ğŸ—“</span><span class="cl">This Week</span></button>
      <button class="chip-btn" onclick="quickAsk('What is on my calendar tomorrow?')"><span class="ci">â­</span><span class="cl">Tomorrow</span></button>
      <button class="chip-btn" onclick="quickFocus('Schedule ')"><span class="ci">â•</span><span class="cl">Add Event</span></button>
    </div>
    <div class="section-label">âœ… Tasks</div>
    <div class="chip-grid">
      <button class="chip-btn" onclick="quickAsk('Show my tasks')"><span class="ci">âœ…</span><span class="cl">My Tasks</span></button>
      <button class="chip-btn" onclick="quickFocus('Add a task: ')"><span class="ci">ğŸ“</span><span class="cl">Add Task</span></button>
    </div>
    <div class="section-label">ğŸ“§ Email</div>
    <div class="chip-grid">
      <button class="chip-btn" onclick="quickAsk('Check my emails')"><span class="ci">ğŸ“¥</span><span class="cl">Check Inbox</span></button>
      <button class="chip-btn" onclick="readEmailsAloud()"><span class="ci">ğŸ”Š</span><span class="cl">Read Emails</span></button>
      <button class="chip-btn" onclick="quickFocus('Search my emails for ')"><span class="ci">ğŸ”</span><span class="cl">Search Email</span></button>
    </div>
    <div class="section-label">ğŸŒ¤ Weather &amp; News</div>
    <div class="chip-grid">
      <button class="chip-btn" onclick="quickAsk('What is the weather today?')"><span class="ci">ğŸŒ¤</span><span class="cl">Weather</span></button>
      <button class="chip-btn" onclick="quickAsk('What is the weather forecast this week?')"><span class="ci">ğŸŒ¦</span><span class="cl">Forecast</span></button>
      <button class="chip-btn" onclick="quickAsk('What is in the news today?')"><span class="ci">ğŸ“°</span><span class="cl">News</span></button>
      <button class="chip-btn" onclick="readNewsAloud()"><span class="ci">ğŸ”Š</span><span class="cl">Read News</span></button>
      <button class="chip-btn" onclick="quickAsk('Give me a quick summary of today')"><span class="ci">ğŸ“‹</span><span class="cl">Summary</span></button>
    </div>
  </div>

  <!-- Tools panel -->
  <div class="drawer-panel" id="panel-tools">
    <div class="section-label">ğŸ—“ Calendar Actions</div>
    <div class="chip-grid">
      <button class="chip-btn" onclick="quickFocus('Schedule a meeting with ')"><span class="ci">ğŸ¤</span><span class="cl">Meeting</span></button>
      <button class="chip-btn" onclick="quickFocus('Block time on ')"><span class="ci">ğŸš«</span><span class="cl">Block Time</span></button>
      <button class="chip-btn" onclick="quickAsk('What do I have this weekend?')"><span class="ci">ğŸ–</span><span class="cl">Weekend</span></button>
      <button class="chip-btn" onclick="quickAsk('Find a free hour on my calendar today')"><span class="ci">ğŸ•</span><span class="cl">Free Time</span></button>
    </div>
    <div class="section-label">ğŸ“§ Email Actions</div>
    <div class="chip-grid">
      <button class="chip-btn" onclick="quickFocus('Draft an email to ')"><span class="ci">âœï¸</span><span class="cl">Draft Email</span></button>
      <button class="chip-btn" onclick="quickAsk('Any important emails today?')"><span class="ci">âš ï¸</span><span class="cl">Important</span></button>
    </div>
    <div class="section-label">ğŸ’¡ Smart Actions</div>
    <div class="chip-grid">
      <button class="chip-btn" onclick="quickAsk('What should I focus on today?')"><span class="ci">ğŸ¯</span><span class="cl">Focus</span></button>
      <button class="chip-btn" onclick="quickAsk('Am I overloaded this week?')"><span class="ci">ğŸ“Š</span><span class="cl">Workload</span></button>
      <button class="chip-btn" onclick="quickAsk('Suggest a task I can do in 30 minutes')"><span class="ci">âš¡</span><span class="cl">Quick Task</span></button>
      <button class="chip-btn" onclick="quickAsk('What did I have planned last week?')"><span class="ci">â®</span><span class="cl">Last Week</span></button>
    </div>
  </div>

  <div style="margin-top:10px; font-size:12px; color:#484f58; text-align:center;">
    <span id="voiceStatus">Tap ğŸ™ to speak</span>
  </div>
</div>

<footer>
  <button id="menuBtn" title="Open menu">â‹¯</button>
  <input id="textInput" type="text" placeholder='Message your plannerâ€¦' autocomplete="off" />
  <button id="micBtn" title="Tap to speak">ğŸ™</button>
  <button id="sendBtn" title="Send">â¤</button>
</footer>

<script>
  // â”€â”€ Auth token: capture from URL after login, persist to localStorage â”€â”€â”€â”€
  (function() {
    const params = new URLSearchParams(location.search);
    const tok = params.get('tok');
    if (tok) {
      localStorage.setItem('authToken', tok);
      history.replaceState({}, '', location.pathname);
    }
  })();

  // â”€â”€ Patch fetch to always send the auth token header â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  const _origFetch = window.fetch.bind(window);
  window.fetch = function(input, init) {
    init = init || {};
    const tok = localStorage.getItem('authToken');
    if (tok) init.headers = Object.assign({ 'X-Auth-Token': tok }, init.headers || {});
    return _origFetch(input, init);
  };

  const chat        = document.getElementById('chat');
  const textInput   = document.getElementById('textInput');
  const sendBtn     = document.getElementById('sendBtn');
  const menuBtn     = document.getElementById('menuBtn');
  const morningBtn  = document.getElementById('morningBtn');
  const digestBtn   = document.getElementById('digestBtn');
  const eveningBtn  = document.getElementById('eveningBtn');
  const clearBtn    = document.getElementById('clearBtn');
  const notifBtn    = document.getElementById('notifBtn');
  const notifBadge  = document.getElementById('notifBadge');
  const muteBtn     = document.getElementById('muteBtn');
  const micBtn      = document.getElementById('micBtn');
  const voiceStatus = document.getElementById('voiceStatus');
  const toastContainer = document.getElementById('toastContainer');
  const drawer      = document.getElementById('drawer');
  const drawerOverlay = document.getElementById('drawer-overlay');

  // â”€â”€ TTS mute state â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  let ttsEnabled = localStorage.getItem('ttsMuted') !== 'true';
  function updateMuteBtn() {
    if (ttsEnabled) {
      muteBtn.textContent = 'ğŸ”Š Voice On';
      muteBtn.classList.remove('active');
    } else {
      muteBtn.textContent = 'ğŸ”‡ Muted';
      muteBtn.classList.add('active');
    }
  }
  updateMuteBtn();
  muteBtn.addEventListener('click', () => {
    ttsEnabled = !ttsEnabled;
    localStorage.setItem('ttsMuted', !ttsEnabled);
    if (!ttsEnabled) window.speechSynthesis?.cancel();
    updateMuteBtn();
  });

  function openDrawer()  { drawer.classList.add('open'); drawerOverlay.classList.add('open'); menuBtn.classList.add('open'); }
  function closeDrawer() { drawer.classList.remove('open'); drawerOverlay.classList.remove('open'); menuBtn.classList.remove('open'); }
  menuBtn.addEventListener('click', () => drawer.classList.contains('open') ? closeDrawer() : openDrawer());
  drawerOverlay.addEventListener('click', closeDrawer);
  // Close drawer only when action buttons are tapped (not tab-switcher buttons)
  drawer.querySelectorAll('button:not(.dtab)').forEach(b => b.addEventListener('click', () => setTimeout(closeDrawer, 150)));

  const USER_ID = 'web-user';
  let unreadNotifs = 0;

  // â”€â”€ GPS location sharing (silent, for traffic-aware alerts) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  function sendGpsLocation() {
    if (!navigator.geolocation) return;
    navigator.geolocation.getCurrentPosition(
      (pos) => {
        fetch('/update-location', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ lat: pos.coords.latitude, lng: pos.coords.longitude }),
        }).catch(() => {}); // silent fail
      },
      () => {}, // permission denied â€” silent
      { timeout: 10000, maximumAge: 60000 }
    );
  }
  // Send on load, then every 15 minutes
  sendGpsLocation();
  setInterval(sendGpsLocation, 15 * 60 * 1000);

  // â”€â”€ Toast notifications â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  function showToast(title, body, urgent = false) {
    const toast = document.createElement('div');
    toast.className = 'toast' + (urgent ? ' urgent' : '');
    toast.innerHTML = `<div class="toast-title">${title}</div>${body != null ? `<div class="toast-body">${body}</div>` : ''}`;
    toastContainer.appendChild(toast);
    // Also show browser notification if permission granted
    if (Notification.permission === 'granted') {
      new Notification(title, { body, icon: '/favicon.ico' });
    }
    // Badge count
    unreadNotifs++;
    notifBadge.style.display = 'block';
    notifBadge.textContent = unreadNotifs > 9 ? '9+' : unreadNotifs;
    // Auto-remove after 6 seconds
    setTimeout(() => {
      toast.style.animation = 'slideOut 0.3s ease forwards';
      setTimeout(() => toast.remove(), 300);
    }, 6000);
  }

  // SSE connection defined at bottom of script (needs auth token)

  // Track recent notifications for history panel
  const recentMobileAlerts = [];
  function addToMobileNotifHistory(title, body) {
    recentMobileAlerts.unshift({ title, body, time: new Date() });
    if (recentMobileAlerts.length > 30) recentMobileAlerts.pop();
    const list = document.getElementById('notif-history-list');
    if (list) {
      list.innerHTML = recentMobileAlerts.map(a =>
        `<div style="padding:7px 0;border-bottom:1px solid var(--border)">
          <div style="font-size:12px;font-weight:600">${a.title}</div>
          <div style="font-size:11px;color:var(--muted);margin-top:1px">${a.body || ''}</div>
          <div style="font-size:10px;color:var(--muted);margin-top:2px">${a.time.toLocaleTimeString('en-US',{hour:'numeric',minute:'2-digit'})}</div>
        </div>`
      ).join('');
    }
  }

  // â”€â”€ Notification bell: toggle history + request browser permission â”€â”€â”€â”€â”€
  notifBtn.addEventListener('click', async () => {
    // Clear badge
    unreadNotifs = 0;
    notifBadge.style.display = 'none';
    // Toggle notification history panel
    const hist = document.getElementById('notif-history');
    hist.style.display = hist.style.display === 'none' ? 'block' : 'none';
    // Request permission if not yet granted
    if (Notification.permission === 'default') {
      const perm = await Notification.requestPermission();
      if (perm === 'granted') {
        notifBtn.classList.add('active');
        showToast('ğŸ”” Notifications enabled', 'You will get alerts for upcoming events!');
      }
    } else if (Notification.permission === 'granted') {
      notifBtn.classList.add('active');
    } else {
      showToast('ğŸ”• Blocked', 'Enable notifications in browser settings.');
    }
  });

  // Auto-check permission on load
  if (Notification.permission === 'granted') notifBtn.classList.add('active');

  // â”€â”€ Web Speech API setup â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
  let recognition = null;
  let isListening = false;

  if (SpeechRecognition) {
    recognition = new SpeechRecognition();
    recognition.lang = 'en-US';
    recognition.interimResults = true;
    recognition.continuous = false;

    recognition.onresult = (event) => {
      const results = Array.from(event.results);
      const transcript = results.map(r => r[0].transcript).join('');
      if (event.results[event.results.length - 1].isFinal) {
        voiceStatus.textContent = 'â³ Sendingâ€¦';
        sendText(transcript);
      } else {
        voiceStatus.textContent = 'ğŸ™ "' + transcript + '"';
      }
    };

    recognition.onerror = (e) => {
      if (e.error === 'not-allowed') {
        const isHttp = location.protocol === 'http:';
        voiceStatus.textContent = isHttp
          ? 'âš ï¸ Mic blocked â€” browser requires HTTPS for microphone access. Use the text input below.'
          : 'âš ï¸ Mic permission denied â€” tap mic again and allow access.';
      } else {
        voiceStatus.textContent = 'âš ï¸ Speech error: ' + e.error;
      }
      micBtn.classList.remove('recording');
      isListening = false;
    };

    recognition.onend = () => {
      micBtn.classList.remove('recording');
      isListening = false;
      voiceStatus.textContent = 'Click the mic button to speak';
    };
  } else {
    micBtn.disabled = true;
    micBtn.style.opacity = '0.4';
    micBtn.title = 'Voice not supported in this browser';
  }

  // On HTTP: mic won't work â€” disable silently, don't show permanent error text
  if (location.protocol === 'http:' && SpeechRecognition) {
    micBtn.title = 'Microphone requires HTTPS';
    micBtn.style.opacity = '0.6';
  }

  // â”€â”€ helpers â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

  // Convert a small subset of markdown to HTML (links, bold, code)
  function renderMarkdown(text) {
    // Extract [label](url) links BEFORE any escaping so URLs aren't corrupted
    const linkPlaceholders = [];
    let processed = text.replace(/\[([^\]]+)\]\((https?:\/\/[^)]+)\)/g, (_, label, url) => {
      const idx = linkPlaceholders.length;
      linkPlaceholders.push(`<a href="${url}" target="_blank" rel="noopener">${escapeHtml(label)}</a>`);
      return `\x00LINK${idx}\x00`;
    });
    // Now escape HTML in the rest of the text
    processed = escapeHtml(processed);
    // Re-insert the links (already safe HTML)
    processed = processed.replace(/\x00LINK(\d+)\x00/g, (_, i) => linkPlaceholders[+i]);
    // **bold**
    processed = processed.replace(/\*\*([^*]+)\*\*/g, '<strong>$1</strong>');
    // `code`
    processed = processed.replace(/`([^`]+)`/g, '<code style="background:#161b22;padding:1px 5px;border-radius:4px;font-size:0.9em">$1</code>');
    // newlines â†’ <br>
    processed = processed.replace(/\n/g, '<br>');
    return processed;
  }

  function escapeHtml(str) {
    return str
      .replace(/&/g, '&amp;')
      .replace(/</g, '&lt;')
      .replace(/>/g, '&gt;');
  }

  // Strip markdown + emojis for TTS
  function stripMarkdown(text) {
    return text
      .replace(/\[([^\]]+)\]\([^)]+\)/g, '$1')   // [label](url) â†’ label
      .replace(/https?:\/\/\S+/g, '')             // bare URLs
      .replace(/\*\*([^*]+)\*\*/g, '$1')          // **bold**
      .replace(/`([^`]+)`/g, '$1')                // `code`
      .replace(/\[[^\]]*\]/g, '')                 // [anything in brackets]
      .replace(/\([^)]*\)/g, '')                  // (anything in parens)
      .replace(/<[^>]*>/g, '')                    // <anything in angle brackets>
      .replace(/[\u{1F000}-\u{1FFFF}]/gu, '')     // emoji supplementary plane
      .replace(/[\u2600-\u27BF]/gu, '')            // misc symbols, dingbats
      .replace(/[\u2300-\u23FF]/gu, '')            // misc technical
      .replace(/[\uFE00-\uFE0F]/gu, '')            // variation selectors
      .replace(/[\u200B-\u200D\uFEFF]/gu, '')      // zero-width chars
      .replace(/[ \t]{2,}/g, ' ')                  // collapse extra spaces (preserve newlines)
      .trim();
  }

  function addBubble(role, text) {
    const wrap = document.createElement('div');

    const label = document.createElement('div');
    label.className = 'label' + (role === 'user' ? ' right' : '');
    label.textContent = role === 'user' ? 'You' : 'Assistant';
    wrap.appendChild(label);

    const bubble = document.createElement('div');
    bubble.className = 'bubble ' + role;
    if (role === 'agent') {
      bubble.innerHTML = renderMarkdown(text);
    } else {
      bubble.textContent = text;
    }
    wrap.appendChild(bubble);

    chat.appendChild(wrap);
    chat.scrollTop = chat.scrollHeight;
    return bubble;
  }

  function addThinking() {
    const wrap = document.createElement('div');
    const label = document.createElement('div');
    label.className = 'label';
    label.textContent = 'Assistant';
    wrap.appendChild(label);
    const bubble = document.createElement('div');
    bubble.className = 'bubble thinking';
    bubble.innerHTML = '<span class="dots"><span>â—</span><span>â—</span><span>â—</span></span>';
    wrap.appendChild(bubble);
    chat.appendChild(wrap);
    chat.scrollTop = chat.scrollHeight;
    return wrap;
  }

  function setButtons(disabled) {
    sendBtn.disabled = disabled;
    morningBtn.disabled = disabled;
    digestBtn.disabled = disabled;
    eveningBtn.disabled = disabled;
    micBtn.disabled = disabled;
  }

  // â”€â”€ Browser TTS (free, no API) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  function speakText(text) {
    if (!ttsEnabled || !window.speechSynthesis) return;
    window.speechSynthesis.cancel(); // stop any current speech

    // Prefer a natural-sounding voice if available
    const voices = window.speechSynthesis.getVoices();
    const preferred = voices.find(v =>
      v.name.includes('Google US English') ||
      v.name.includes('Samantha') ||
      v.name.includes('Karen') ||
      (v.lang === 'en-US' && v.localService)
    );

    // Split on newlines; each non-empty line becomes its own utterance
    // so the browser's natural pause between utterances mimics a newline break
    const lines = text.split(/\n+/).map(l => l.trim()).filter(l => l.length > 0);
    if (lines.length === 0) return;

    lines.forEach((line, i) => {
      const utt = new SpeechSynthesisUtterance(line);
      utt.lang = 'en-US';
      utt.rate = 1.05;
      utt.pitch = 1;
      if (preferred) utt.voice = preferred;
      window.speechSynthesis.speak(utt);
    });
  }

  // â”€â”€ TTS voice shortcut: read news headlines aloud â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  async function readNewsAloud() {
    closeDrawer();
    try {
      const r = await fetch('/api/briefing');
      if (r.status === 401) { showToast('ğŸ”’ Session expired', 'Please log in again'); return; }
      if (!r.ok) throw new Error('Server error ' + r.status);
      const ct = r.headers.get('content-type') || '';
      if (!ct.includes('application/json')) throw new Error('Unexpected response from server');
      const data = await r.json();
      const news = data.news ?? [];
      if (!news.length || news.every(n => !n.articles?.length)) {
        addBubble('agent', 'ğŸ“° No news loaded yet. Try refreshing your briefing.');
        return;
      }
      // Build chat bubble with headlines
      const bubbleLines = ['ğŸ“° **Today\'s top headlines:**'];
      const ttsLines = ['Here are today\'s top headlines.'];
      for (const section of news) {
        if (!section.articles?.length) continue;
        bubbleLines.push(`\n**${section.topic}**`);
        ttsLines.push(section.topic + ':');
        for (const a of section.articles.slice(0, 3)) {
          bubbleLines.push(`â€¢ ${a.title}`);
          ttsLines.push(a.title);
        }
      }
      addBubble('agent', bubbleLines.join('\n'));
      chat.scrollTop = chat.scrollHeight;
      speakText(ttsLines.join('\n'));
    } catch (e) { showToast('ğŸ“° Could not load news', String(e)); }
  }

  // â”€â”€ TTS voice shortcut: read today\'s emails aloud â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  async function readEmailsAloud() {
    closeDrawer();
    try {
      const r = await fetch('/api/briefing');
      if (r.status === 401) { showToast('ğŸ”’ Session expired', 'Please log in again'); return; }
      if (!r.ok) throw new Error('Server error ' + r.status);
      const ct = r.headers.get('content-type') || '';
      if (!ct.includes('application/json')) throw new Error('Unexpected response from server');
      const data = await r.json();
      const emails = data.emails ?? [];
      const important = data.importantEmails ?? [];
      if (!emails.length && !important.length) {
        addBubble('agent', 'ğŸ“­ Your inbox is clear. No unread emails.');
        speakText('Your inbox is clear. No unread emails.');
        return;
      }
      // Build display text shown as a chat bubble
      const lines = [`ğŸ“§ **You have ${emails.length} unread email${emails.length !== 1 ? 's' : ''}.**`];
      if (important.length) {
        lines.push(`\nâš ï¸ **${important.length} important:**`);
        for (const e of important.slice(0, 3)) {
          const sender = (e.from || 'Unknown').split('<')[0].trim() || 'Unknown';
          lines.push(`â€¢ From **${sender}**: ${e.subject || '(no subject)'}`);
        }
      }
      if (emails.length) {
        lines.push(`\nğŸ“¥ **Recent emails:**`);
        for (const e of emails.slice(0, 5)) {
          const sender = (e.from || 'Unknown').split('<')[0].trim() || 'Unknown';
          lines.push(`â€¢ From **${sender}**: ${e.subject || '(no subject)'}`);
        }
      }
      addBubble('agent', lines.join('\n'));
      chat.scrollTop = chat.scrollHeight;
      // TTS â€” may be blocked on iOS after await, but text is already shown above
      const ttsLines = [
        `You have ${emails.length} unread email${emails.length !== 1 ? 's' : ''}.`,
        ...(important.map(e => `From ${(e.from||'Unknown').split('<')[0].trim()}: ${e.subject||'no subject'}`).slice(0,3)),
        ...(emails.slice(0, 5).map(e => `From ${(e.from||'Unknown').split('<')[0].trim()}: ${e.subject||'no subject'}`))
      ];
      speakText(ttsLines.join('\n'));
    } catch (e) { showToast('ğŸ“§ Could not load emails', String(e)); }
  }

  // Voices load async â€” preload them
  window.speechSynthesis?.getVoices();
  window.speechSynthesis?.addEventListener('voiceschanged', () => window.speechSynthesis.getVoices());

  // â”€â”€ text send â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  let _sendFromInput = false; // true only when triggered by the text input
  async function sendText(msg, fromInput = false) {
    if (!msg.trim()) return;
    _sendFromInput = fromInput;
    textInput.value = '';
    addBubble('user', msg);
    const thinking = addThinking();
    setButtons(true);

    try {
      const res = await fetch('/voice-chat', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ text: msg, userId: USER_ID }),
      });
      if (res.status === 401) {
        thinking.remove();
        addBubble('agent', 'ğŸ”’ Session expired â€” redirecting to loginâ€¦');
        setTimeout(() => { window.location.href = '/login'; }, 1500);
        return;
      }
      const data = await res.json();
      thinking.remove();
      const reply = data.reply || data.error || 'No response';
      addBubble('agent', reply);
      speakText(stripMarkdown(reply));
    } catch (e) {
      thinking.remove();
      addBubble('agent', 'âš ï¸ Network error: ' + e.message);
    } finally {
      setButtons(false);
      voiceStatus.textContent = 'Click the mic button to speak';
      // Only re-focus the input if the user typed in it â€” prevents keyboard
      // popping up on mobile when chip/action buttons trigger sends
      if (_sendFromInput) textInput.focus();
    }
  }

  sendBtn.addEventListener('click', () => sendText(textInput.value, true));
  textInput.addEventListener('keydown', e => { if (e.key === 'Enter' && !e.shiftKey) sendText(textInput.value, true); });
  morningBtn.addEventListener('click', () => sendText('/morning'));
  eveningBtn.addEventListener('click', () => sendText('/evening'));
  digestBtn.addEventListener('click', async () => {
    setButtons(true);
    digestBtn.textContent = 'ğŸ“§ Sendingâ€¦';
    try {
      const res = await fetch('/send-digest', { method: 'POST' });
      const data = await res.json();
      if (data.ok) {
        showToast('ğŸ“§ Digest sent!', `Morning briefing emailed successfully.`);
        addBubble('agent', 'âœ… Morning digest email sent!');
      } else {
        addBubble('agent', `âŒ Email failed: ${data.error}`);
      }
    } catch (e) {
      addBubble('agent', 'âš ï¸ Could not send digest: ' + e.message);
    } finally {
      digestBtn.textContent = 'ğŸ“§ Email Digest';
      setButtons(false);
    }
  });
  clearBtn.addEventListener('click', async () => {
    window.speechSynthesis?.cancel();
    await fetch('/voice-chat', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ text: '/clear', userId: USER_ID }),
    });
    chat.innerHTML = '<div class="bubble system">Conversation cleared.</div>';
  });

  // â”€â”€ Drawer tab switching â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  function switchDrawerTab(name) {
    document.querySelectorAll('.dtab').forEach(t => t.classList.toggle('active', t.id === 'tab-' + name));
    document.querySelectorAll('.drawer-panel').forEach(p => p.classList.toggle('active', p.id === 'panel-' + name));
  }

  // Quick ask: close drawer then send
  function quickAsk(msg) {
    closeDrawer();
    setTimeout(() => sendText(msg), 200);
  }

  // Quick focus: close drawer then pre-fill input
  function quickFocus(prefix) {
    closeDrawer();
    setTimeout(() => {
      textInput.value = prefix;
      textInput.focus();
      textInput.setSelectionRange(prefix.length, prefix.length);
    }, 250);
  }

  // â”€â”€ Mic button: click to toggle listening â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  micBtn.addEventListener('click', () => {
    if (!recognition) return;
    if (isListening) {
      recognition.stop();
      isListening = false;
      micBtn.classList.remove('recording');
      voiceStatus.textContent = 'Click the mic button to speak';
    } else {
      window.speechSynthesis?.cancel(); // stop TTS before listening
      recognition.start();
      isListening = true;
      micBtn.classList.add('recording');
      voiceStatus.textContent = 'ğŸ”´ Listeningâ€¦ speak now';
    }
  });
// â”€â”€â”€ Service Worker + Web Push â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function registerPush() {
  if (!('serviceWorker' in navigator) || !('PushManager' in window)) return;
  if (Notification.permission === 'denied') return;
  try {
    const reg = await navigator.serviceWorker.register('/service-worker.js');
    const keyRes = await fetch('/vapid-public-key');
    if (!keyRes.ok) return;
    const { key } = await keyRes.json();
    let sub = await reg.pushManager.getSubscription();
    if (sub) {
      // Already subscribed â€” only re-POST if endpoint changed
      const stored = localStorage.getItem('pushEndpoint');
      if (stored === sub.endpoint) return;
      localStorage.setItem('pushEndpoint', sub.endpoint);
      await fetch('/push-subscribe', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(sub) });
      return;
    }
    // No sub yet â€” only subscribe if permission already granted (don't auto-prompt)
    if (Notification.permission !== 'granted') return;
    sub = await reg.pushManager.subscribe({ userVisibleOnly: true, applicationServerKey: key });
    localStorage.setItem('pushEndpoint', sub.endpoint);
    await fetch('/push-subscribe', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(sub) });
  } catch (e) {
    console.warn('Push registration failed:', e);
  }
}
registerPush();
connectSSE();

// SSE also needs the auth token (EventSource can't send headers â€” use query param)
function connectSSE() {
  const tok = localStorage.getItem('authToken');
  const es = new EventSource('/notifications' + (tok ? '?tok=' + encodeURIComponent(tok) : ''));
  es.addEventListener('notification', (e) => {
    try {
      const alert = JSON.parse(e.data);
      showToast(alert.title, alert.body, alert.type === 'event_starting');
      addToMobileNotifHistory(alert.title, alert.body);
    } catch {}
  });
  es.addEventListener('error', () => { es.close(); setTimeout(connectSSE, 5000); });
}
</script>

</body>
</html>
