<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Daily Planner â€” Dashboard</title>
  <link rel="manifest" href="/manifest.json" />
  <style>
    *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }

    :root {
      --bg:       #0d1117;
      --surface:  #161b22;
      --surface2: #21262d;
      --border:   #30363d;
      --text:     #e6edf3;
      --muted:    #8b949e;
      --accent:   #1f6feb;
      --accent2:  #388bfd;
      --green:    #3fb950;
      --yellow:   #d29922;
      --red:      #f85149;
      --orange:   #db6d28;
      --purple:   #a371f7;
      --sidebar-w: 220px;
      --right-w:   320px;
    }

    html, body { height: 100%; overflow: hidden; font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif; background: var(--bg); color: var(--text); font-size: 14px; }

    /* â”€â”€ Layout â”€â”€ */
    #app { display: grid; grid-template-columns: var(--sidebar-w) 1fr var(--right-w); grid-template-rows: 48px 1fr; height: 100vh; }

    /* â”€â”€ Top bar â”€â”€ */
    #topbar {
      grid-column: 1 / -1;
      background: var(--surface);
      border-bottom: 1px solid var(--border);
      display: flex;
      align-items: center;
      padding: 0 20px;
      gap: 14px;
      z-index: 10;
    }
    #topbar .logo { font-weight: 700; font-size: 15px; display: flex; align-items: center; gap: 8px; }
    #topbar .logo .dot { width: 8px; height: 8px; border-radius: 50%; background: var(--green); box-shadow: 0 0 6px var(--green); }
    #topbar .date-time { color: var(--muted); font-size: 12px; margin-left: 4px; }
    #topbar .spacer { flex: 1; }
    #topbar .top-actions { display: flex; align-items: center; gap: 8px; }
    .icon-btn {
      background: transparent;
      border: 1px solid var(--border);
      border-radius: 8px;
      color: var(--muted);
      padding: 5px 10px;
      font-size: 13px;
      cursor: pointer;
      transition: background .15s, color .15s, border-color .15s;
      display: flex; align-items: center; gap: 5px;
    }
    .icon-btn:hover { background: var(--surface2); color: var(--text); border-color: var(--accent); }
    .icon-btn.active { color: var(--green); border-color: var(--green); }
    #notifBadge {
      background: var(--red); color: #fff; border-radius: 10px;
      padding: 1px 5px; font-size: 10px; font-weight: 700; display: none;
    }

    /* â”€â”€ Left Sidebar â”€â”€ */
    #sidebar {
      background: var(--surface);
      border-right: 1px solid var(--border);
      display: flex;
      flex-direction: column;
      padding: 12px 0;
      overflow-y: auto;
    }
    .nav-section { padding: 0 12px; margin-bottom: 4px; }
    .nav-label { font-size: 10px; font-weight: 600; color: var(--muted); text-transform: uppercase; letter-spacing: .08em; padding: 8px 8px 4px; }
    .nav-btn {
      display: flex; align-items: center; gap: 9px;
      width: 100%; padding: 8px 10px; border-radius: 8px;
      background: none; border: none; color: var(--muted);
      cursor: pointer; font-size: 13px; font-weight: 500;
      transition: background .15s, color .15s;
      text-align: left;
    }
    .nav-btn:hover { background: var(--surface2); color: var(--text); }
    .nav-btn.active { background: rgba(31,111,235,.15); color: var(--accent2); }
    .nav-btn .icon { font-size: 16px; width: 20px; text-align: center; flex-shrink: 0; }
    .nav-btn .badge { margin-left: auto; background: var(--red); color: #fff; border-radius: 10px; padding: 1px 6px; font-size: 10px; font-weight: 700; }
    .nav-btn .badge.green { background: var(--green); }
    .nav-btn .badge.blue  { background: #3b82f6; }
    .nav-divider { height: 1px; background: var(--border); margin: 8px 12px; }
    #sidebar .bottom { margin-top: auto; padding: 0 12px; }

    /* â”€â”€ Center: Chat â”€â”€ */
    #center {
      display: flex;
      flex-direction: column;
      overflow: hidden;
      background: var(--bg);
    }
    #chat-header {
      padding: 12px 20px;
      border-bottom: 1px solid var(--border);
      display: flex; align-items: center; gap: 10px;
      background: var(--bg);
      flex-shrink: 0;
    }
    #chat-header h2 { font-size: 14px; font-weight: 600; }
    #chat-header .subtitle { color: var(--muted); font-size: 12px; }
    #chat { flex: 1; overflow-y: auto; padding: 20px; display: flex; flex-direction: column; gap: 14px; scroll-behavior: smooth; }

    /* scrollbar */
    #chat::-webkit-scrollbar { width: 6px; }
    #chat::-webkit-scrollbar-track { background: transparent; }
    #chat::-webkit-scrollbar-thumb { background: var(--border); border-radius: 3px; }

    .msg-row { display: flex; flex-direction: column; gap: 3px; }
    .msg-row.user { align-items: flex-end; }
    .msg-label { font-size: 11px; color: var(--muted); padding: 0 4px; }
    .bubble {
      max-width: 72%;
      padding: 10px 14px;
      border-radius: 16px;
      line-height: 1.55;
      font-size: 13.5px;
      white-space: pre-wrap;
      word-break: break-word;
    }
    .bubble.user { background: var(--accent); color: #fff; border-bottom-right-radius: 4px; }
    .bubble.agent { background: var(--surface); border: 1px solid var(--border); border-bottom-left-radius: 4px; }
    .bubble.system { background: transparent; border: 1px dashed var(--border); color: var(--muted); font-size: 12px; align-self: center; max-width: 90%; text-align: center; }
    .bubble.thinking { background: var(--surface); border: 1px solid var(--border); color: var(--muted); font-size: 13px; border-bottom-left-radius: 4px; }
    .bubble a { color: var(--accent2); text-decoration: underline; }
    .bubble a:hover { color: #79c0ff; }
    .bubble strong { font-weight: 600; }
    .bubble code { background: var(--bg); padding: 1px 5px; border-radius: 4px; font-size: 0.9em; }
    .dots span { animation: blink 1.2s infinite; }
    .dots span:nth-child(2) { animation-delay: .2s; }
    .dots span:nth-child(3) { animation-delay: .4s; }
    @keyframes blink { 0%,80%,100%{opacity:.2} 40%{opacity:1} }

    /* â”€â”€ Input bar â”€â”€ */
    #input-area {
      padding: 12px 16px;
      border-top: 1px solid var(--border);
      background: var(--bg);
      flex-shrink: 0;
    }
    #input-row { display: flex; gap: 8px; align-items: center; }
    #textInput {
      flex: 1; background: var(--surface2); border: 1px solid var(--border);
      border-radius: 22px; color: var(--text); padding: 10px 16px;
      font-size: 14px; outline: none; transition: border-color .2s;
    }
    #textInput:focus { border-color: var(--accent); }
    #textInput::placeholder { color: var(--muted); }
    .send-btn {
      background: var(--accent); color: #fff; border: none; border-radius: 50%;
      width: 40px; height: 40px; font-size: 18px; cursor: pointer;
      display: flex; align-items: center; justify-content: center;
      transition: background .15s, transform .1s; flex-shrink: 0;
    }
    .send-btn:hover { background: var(--accent2); }
    .send-btn:active { transform: scale(.92); }
    .send-btn:disabled { opacity: .4; cursor: not-allowed; }
    #voice-status { font-size: 11px; color: var(--muted); margin-top: 5px; text-align: center; min-height: 14px; }

    /* â”€â”€ Right Panel â”€â”€ */
    #right {
      border-left: 1px solid var(--border);
      background: var(--bg);
      display: flex;
      flex-direction: column;
      overflow: hidden;
    }
    #right-tabs {
      display: flex;
      border-bottom: 1px solid var(--border);
      background: var(--surface);
      flex-shrink: 0;
      overflow-x: auto;
    }
    #right-tabs::-webkit-scrollbar { display: none; }
    .rtab {
      flex: 1; min-width: 0; padding: 10px 2px; text-align: center; font-size: 20px; font-weight: 600;
      color: var(--muted); background: none; border: none; cursor: pointer;
      border-bottom: 2px solid transparent; transition: color .15s, border-color .15s;
      white-space: nowrap; overflow: visible; line-height: 1;
    }
    .rtab:hover { color: var(--text); }
    .rtab.active { color: var(--accent2); border-bottom-color: var(--accent2); }

    .notif-item { padding: 8px 10px; border-radius: 6px; background: var(--surface2); margin-bottom: 6px; }
    .notif-item-title { font-size: 12px; font-weight: 600; }
    .notif-item-body { font-size: 11px; color: var(--muted); margin-top: 2px; }
    .notif-item-time { font-size: 10px; color: var(--muted); margin-top: 3px; }
    #right-content { flex: 1; overflow-y: auto; padding: 14px; display: flex; flex-direction: column; gap: 12px; }
    #right-content::-webkit-scrollbar { width: 4px; }
    #right-content::-webkit-scrollbar-thumb { background: var(--border); border-radius: 2px; }

    .panel { display: none; flex-direction: column; gap: 12px; }
    .panel.active { display: flex; }

    /* â”€â”€ Widget Cards â”€â”€ */
    .card {
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: 12px;
      padding: 14px;
    }
    .card-title {
      font-size: 11px; font-weight: 700; color: var(--muted);
      text-transform: uppercase; letter-spacing: .08em;
      margin-bottom: 10px; display: flex; align-items: center; gap: 6px;
    }
    .card-title .refresh-btn {
      margin-left: auto; background: none; border: none; color: var(--muted);
      cursor: pointer; font-size: 13px; padding: 2px 4px; border-radius: 4px;
      transition: color .15s, background .15s;
    }
    .card-title .refresh-btn:hover { color: var(--text); background: var(--surface2); }

    /* Weather */
    .weather-main { display: flex; align-items: center; gap: 14px; margin-bottom: 8px; }
    .weather-icon { font-size: 40px; line-height: 1; }
    .weather-temp { font-size: 36px; font-weight: 300; line-height: 1; }
    .weather-temp span { font-size: 16px; font-weight: 500; color: var(--muted); }
    .weather-desc { color: var(--muted); font-size: 12px; margin-top: 2px; }
    .weather-meta { display: grid; grid-template-columns: 1fr 1fr; gap: 6px 10px; margin-top: 8px; }
    .weather-meta-item { font-size: 11px; color: var(--muted); display: flex; gap: 4px; }
    .weather-meta-item strong { color: var(--text); }

    /* Calendar */
    .event-item { display: flex; gap: 10px; align-items: flex-start; padding: 7px 0; border-bottom: 1px solid var(--border); }
    .event-item:last-child { border-bottom: none; padding-bottom: 0; }
    .event-time { font-size: 11px; color: var(--muted); min-width: 70px; padding-top: 1px; white-space: nowrap; }
    .event-dot { width: 8px; height: 8px; border-radius: 50%; background: var(--accent); margin-top: 4px; flex-shrink: 0; }
    .event-title { font-size: 13px; font-weight: 500; line-height: 1.3; }
    .event-loc { font-size: 11px; color: var(--muted); margin-top: 1px; }

    /* Tasks */
    .task-item { display: flex; align-items: flex-start; gap: 10px; padding: 7px 0; border-bottom: 1px solid var(--border); }
    .task-item:last-child { border-bottom: none; }
    .task-check {
      width: 16px; height: 16px; border: 2px solid var(--border); border-radius: 4px;
      cursor: pointer; flex-shrink: 0; margin-top: 1px; transition: background .15s, border-color .15s;
      display: flex; align-items: center; justify-content: center;
    }
    .task-check:hover { border-color: var(--green); }
    .task-check.done { background: var(--green); border-color: var(--green); }
    .task-check.done::after { content: "âœ“"; color: #fff; font-size: 10px; font-weight: 700; }
    .task-title { font-size: 13px; line-height: 1.3; }
    .task-due { font-size: 11px; color: var(--muted); margin-top: 2px; }

    /* Email */
    .email-item { padding: 8px 0; border-bottom: 1px solid var(--border); cursor: pointer; }
    .email-item:last-child { border-bottom: none; }
    .email-item:hover .email-subject { color: var(--accent2); }
    .email-from { font-size: 11px; color: var(--muted); display: flex; align-items: center; gap: 6px; margin-bottom: 2px; }
    .email-from .imp { color: var(--yellow); font-size: 10px; }
    .email-from .acct { background: var(--surface2); border-radius: 4px; padding: 1px 5px; font-size: 10px; }
    .email-from .vip-badge { background: #b58900; color: #fff; border-radius: 4px; padding: 1px 5px; font-size: 10px; font-weight: 600; }
    .email-from .hl-badge  { background: #1a3a1a; color: #3fb950; border-radius: 4px; padding: 1px 5px; font-size: 10px; }
    .email-item.email-vip  { border-left: 3px solid #b58900; padding-left: 8px; }
    .email-item.email-hl   { border-left: 3px solid #3fb950; padding-left: 8px; }
    .email-subject { font-size: 13px; font-weight: 500; }
    .email-snippet { font-size: 11px; color: var(--muted); margin-top: 2px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }

    /* News */
    .news-topic { font-size: 11px; font-weight: 700; color: var(--purple); text-transform: uppercase; letter-spacing: .06em; margin: 10px 0 6px; }
    .news-topic:first-child { margin-top: 0; }
    .news-article { padding: 6px 0; border-bottom: 1px solid var(--border); cursor: pointer; }
    .news-article:last-child { border-bottom: none; }
    .news-article a { color: var(--accent2); text-decoration: underline; text-underline-offset: 2px; text-decoration-color: transparent; font-size: 13px; font-weight: 500; line-height: 1.4; display: block; transition: color .15s, text-decoration-color .15s; }
    .news-article a:hover { color: #79c0ff; text-decoration-color: #79c0ff; }
    .news-article a::after { content: " â†—"; font-size: 10px; opacity: 0.5; }
    .news-source { font-size: 11px; color: var(--muted); margin-top: 2px; }

    /* Quick action chips â€” hidden on desktop (nav covers it), visible on mobile */
    .quick-chips { display: none; flex-wrap: wrap; gap: 6px; padding: 10px 16px 0; }
    .chip {
      background: var(--surface); border: 1px solid var(--border); border-radius: 20px;
      padding: 5px 12px; font-size: 12px; color: var(--muted); cursor: pointer;
      transition: background .15s, color .15s, border-color .15s;
    }
    .chip:hover { background: var(--surface2); color: var(--text); border-color: var(--accent); }

    /* Proactive Suggestions Banner */
    #suggestions-banner {
      display: none;
      background: #1c2012;
      border: 1px solid #3a5a1a;
      border-radius: 10px;
      padding: 10px 12px;
      margin-bottom: 10px;
    }
    #suggestions-banner .sug-title { font-size: 11px; font-weight: 700; color: #7ee787; text-transform: uppercase; letter-spacing: .06em; margin-bottom: 6px; }
    #suggestions-banner .sug-item { font-size: 12px; color: #cae8a0; padding: 3px 0; border-bottom: 1px solid rgba(255,255,255,.05); }
    #suggestions-banner .sug-item:last-child { border-bottom: none; }
    #suggestions-dismiss { float: right; background: none; border: none; color: #7ee787; cursor: pointer; font-size: 14px; padding: 0 2px; }

    /* Package tracking */
    .pkg-item { padding: 8px 0; border-bottom: 1px solid var(--border); }
    .pkg-item:last-child { border-bottom: none; }
    .pkg-carrier { font-size: 10px; font-weight: 700; text-transform: uppercase; letter-spacing: .06em; color: var(--muted); margin-bottom: 2px; }
    .pkg-number  { font-size: 13px; font-family: monospace; color: var(--accent2); }
    .pkg-subject { font-size: 11px; color: var(--muted); margin-top: 2px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }

    /* â”€â”€ Settings Modal â”€â”€ */
    #settings-overlay {
      display: none; position: fixed; inset: 0; background: rgba(0,0,0,.7);
      z-index: 1000; align-items: center; justify-content: center;
      backdrop-filter: blur(4px);
    }
    #settings-overlay.open { display: flex; }
    #settings-modal {
      background: var(--surface); border: 1px solid var(--border); border-radius: 16px;
      width: 520px; max-width: 95vw; max-height: 85vh; overflow-y: auto;
      padding: 28px;
    }
    #settings-modal h2 { font-size: 18px; font-weight: 700; margin-bottom: 6px; }
    #settings-modal .subtitle { color: var(--muted); font-size: 13px; margin-bottom: 24px; }
    .setting-section { margin-bottom: 24px; }
    .setting-label { font-size: 12px; font-weight: 600; color: var(--muted); text-transform: uppercase; letter-spacing: .08em; margin-bottom: 10px; }
    .topic-list { display: flex; flex-direction: column; gap: 6px; margin-bottom: 10px; }
    .topic-row { display: flex; gap: 8px; align-items: center; }
    .topic-input {
      flex: 1; background: var(--surface2); border: 1px solid var(--border);
      border-radius: 8px; color: var(--text); padding: 8px 12px; font-size: 13px; outline: none;
    }
    .topic-input:focus { border-color: var(--accent); }
    .remove-btn {
      background: none; border: 1px solid var(--border); border-radius: 6px;
      color: var(--red); cursor: pointer; padding: 6px 10px; font-size: 14px;
      transition: background .15s;
    }
    .remove-btn:hover { background: rgba(248,81,73,.1); }
    .add-topic-btn {
      background: none; border: 1px dashed var(--border); border-radius: 8px;
      color: var(--muted); padding: 7px 14px; font-size: 13px; cursor: pointer;
      width: 100%; transition: border-color .15s, color .15s;
    }
    .add-topic-btn:hover { border-color: var(--accent); color: var(--text); }
    .modal-footer { display: flex; gap: 10px; margin-top: 4px; justify-content: flex-end; }
    .btn-primary { background: var(--accent); color: #fff; border: none; border-radius: 8px; padding: 9px 20px; font-size: 13px; font-weight: 600; cursor: pointer; transition: background .15s; }
    .btn-primary:hover { background: var(--accent2); }
    .btn-secondary { background: var(--surface2); color: var(--text); border: 1px solid var(--border); border-radius: 8px; padding: 9px 20px; font-size: 13px; font-weight: 600; cursor: pointer; transition: background .15s; }
    .btn-secondary:hover { background: var(--border); }

    /* Toast */
    #toast-container { position: fixed; top: 60px; right: 16px; z-index: 9999; display: flex; flex-direction: column; gap: 8px; pointer-events: none; }
    .toast { background: var(--surface); border: 1px solid var(--border); border-left: 4px solid var(--green); border-radius: 8px; padding: 11px 15px; min-width: 260px; box-shadow: 0 4px 20px rgba(0,0,0,.5); animation: tSlide .3s ease; pointer-events: all; }
    .toast.urgent { border-left-color: var(--red); }
    .toast-title { font-weight: 600; font-size: 13px; }
    .toast-body { font-size: 12px; color: var(--muted); margin-top: 2px; }
    @keyframes tSlide { from{transform:translateX(110%);opacity:0} to{transform:translateX(0);opacity:1} }
    @keyframes tOut { to{transform:translateX(110%);opacity:0} }

    /* Loading spinner */
    .spinner { width: 18px; height: 18px; border: 2px solid var(--border); border-top-color: var(--accent); border-radius: 50%; animation: spin .7s linear infinite; display: inline-block; }
    @keyframes spin { to{transform:rotate(360deg)} }

    .empty-state { color: var(--muted); font-size: 12px; text-align: center; padding: 16px 0; }

    /* Scrollbar right panel */
    #right-content::-webkit-scrollbar { width: 4px; }
    #right-content::-webkit-scrollbar-track { background: transparent; }
  </style>
</head>
<body>
<div id="app">

  <!-- â”€â”€ Top Bar â”€â”€ -->
  <header id="topbar">
    <div class="logo"><div class="dot"></div> Daily Planner Agent</div>
    <div class="date-time" id="clock"></div>
    <div class="spacer"></div>
    <span id="last-updated" style="font-size:11px;color:var(--muted);margin-right:4px"></span>
    <div class="top-actions">
      <button class="icon-btn" id="notifBtn" title="Notifications">ğŸ”” <span id="notifBadge"></span></button>
      <button class="icon-btn" id="digestBtn">ğŸ“§ Send Digest</button>
      <button class="icon-btn" id="settingsBtn">âš™ï¸ Settings</button>
      <button class="icon-btn" onclick="window.location.href='/logout'">â†© Logout</button>
    </div>
  </header>

  <!-- â”€â”€ Left Sidebar â”€â”€ -->
  <nav id="sidebar">
    <div class="nav-section">
      <div class="nav-label">Chat</div>
      <button class="nav-btn active" onclick="sendQuick('/morning')"><span class="icon">â˜€ï¸</span> Morning Briefing</button>
      <button class="nav-btn" onclick="sendQuick('/evening')"><span class="icon">ğŸŒ™</span> Evening Briefing</button>
      <button class="nav-btn" onclick="sendQuick('What is on my calendar today?')"><span class="icon">ğŸ“…</span> Today's Calendar <span class="badge blue" id="calTodayBadge" style="display:none">0</span></button>
      <button class="nav-btn" onclick="sendQuick('What is on my calendar this week?')"><span class="icon">ğŸ—“</span> This Week <span class="badge blue" id="calWeekBadge" style="display:none">0</span></button>
      <button class="nav-btn" onclick="sendQuick('Check my emails')"><span class="icon">ğŸ“§</span> Check Emails <span class="badge" id="emailBadge" style="display:none">0</span></button>
      <button class="nav-btn" onclick="sendQuick('Show my tasks')"><span class="icon">âœ…</span> My Tasks <span class="badge green" id="taskBadge" style="display:none">0</span></button>
      <button class="nav-btn" onclick="switchTab('reminders')"><span class="icon">ğŸ””</span> Reminders <span class="badge" id="reminderBadge" style="display:none">0</span></button>
      <button class="nav-btn" onclick="sendQuick('What is the weather today?')"><span class="icon">ğŸŒ¤</span> Weather</button>
      <button class="nav-btn" onclick="sendQuick('What is the weather forecast this week?')"><span class="icon">ğŸŒ¦</span> Forecast</button>
      <button class="nav-btn" id="newsNavBtn" onclick="sendQuick('What is in the news today?')"><span class="icon">ğŸ“°</span> Latest News</button>
    </div>
    <div class="nav-divider"></div>
    <div class="nav-section">
      <div class="nav-label">Actions</div>
      <button class="nav-btn" onclick="focusInput('Schedule ')"><span class="icon">â•</span> Add Event</button>
      <button class="nav-btn" onclick="focusInput('Add a task: ')"><span class="icon">ğŸ“</span> Add Task</button>
      <button class="nav-btn" onclick="sendQuick('Search my emails for ')"><span class="icon">ğŸ”</span> Search Emails</button>
    </div>
    <div class="nav-divider"></div>
    <div class="bottom nav-section">
    </div>
  </nav>

  <!-- â”€â”€ Center: Chat â”€â”€ -->
  <main id="center">
    <div id="chat-header">
      <span style="font-size:20px">ğŸ¤–</span>
      <div>
        <div id="chat-title" style="font-size:14px;font-weight:600">Daily Planner Agent</div>
        <div class="subtitle" id="chat-subtitle">Ask me anything about your day</div>
      </div>
      <button id="muteBtn" title="Mute voice reading" style="margin-left:auto;background:none;border:1px solid var(--border);border-radius:8px;color:var(--muted);font-size:12px;cursor:pointer;padding:3px 8px;white-space:nowrap">ğŸ”Š Voice</button>
    </div>

    <!-- Quick action chips -->
    <div class="quick-chips">
      <div class="chip" onclick="sendQuick('What is on my calendar today?')">ğŸ“… Today</div>
      <div class="chip" onclick="sendQuick('Check my emails')">ğŸ“§ Emails</div>
      <div class="chip" onclick="sendQuick('Show my tasks')">âœ… Tasks</div>
      <div class="chip" onclick="sendQuick('Show my reminders')">ğŸ”” Reminders</div>
      <div class="chip" onclick="sendQuick('What is the weather today?')">ğŸŒ¤ Weather</div>
      <div class="chip" onclick="sendQuick('What is in the news today?')">ğŸ“° News</div>
    </div>

    <div id="chat"></div>

    <div id="input-area">
      <div id="input-row">
        <button onclick="clearChat()" title="Clear chat" style="background:none;border:1px solid var(--border);color:var(--muted);font-size:16px;cursor:pointer;padding:0;width:38px;height:38px;border-radius:8px;flex-shrink:0;line-height:1" onmouseover="this.style.color='#f85149';this.style.borderColor='#6e1a1a'" onmouseout="this.style.color='var(--muted)';this.style.borderColor='var(--border)'">ğŸ—‘</button>
        <input id="textInput" type="text" placeholder="Ask anythingâ€¦ schedule, emails, tasks, weather, news" autocomplete="off" />
        <button class="send-btn" id="micBtn" style="background:var(--surface2);border:1px solid var(--border);color:var(--text);font-size:22px" title="Mic">ğŸ™</button>
        <button class="send-btn" id="sendBtn" title="Send">â¤</button>
      </div>
      <div id="voice-status"></div>
    </div>
  </main>

  <!-- â”€â”€ Right Panel â”€â”€ -->
  <aside id="right">
    <div id="right-tabs">
      <button class="rtab active" data-panel="overview" onclick="switchTab('overview')" title="Overview">ğŸ </button>
      <button class="rtab" data-panel="calendar" onclick="switchTab('calendar')" title="Calendar">ğŸ“…</button>
      <button class="rtab" data-panel="tasks" onclick="switchTab('tasks')" title="Tasks">âœ…</button>
      <button class="rtab" data-panel="reminders" onclick="switchTab('reminders')" title="Reminders">ğŸ””</button>
      <button class="rtab" data-panel="email" onclick="switchTab('email')" title="Email">âœ‰ï¸</button>
      <button class="rtab" data-panel="news" onclick="switchTab('news')" title="News">ğŸ“°</button>
      <button class="rtab" data-panel="packages" onclick="switchTab('packages')" title="Packages">ğŸ“¦</button>
    </div>
    <div id="right-content">

      <!-- Overview Tab -->
      <div class="panel active" id="panel-overview">
        <!-- Proactive suggestions banner -->
        <div id="suggestions-banner">
          <button id="suggestions-dismiss" onclick="dismissSuggestions()" title="Dismiss">âœ•</button>
          <div class="sug-title">ğŸ’¡ Smart Suggestions</div>
          <div id="suggestions-list"></div>
        </div>
        <!-- Weather widget -->
        <div class="card" id="weather-card">
          <div class="card-title">ğŸŒ¤ Weather <button class="refresh-btn" onclick="loadBriefing(true)" title="Refresh">âŸ³</button></div>
          <div id="weather-body"><div class="spinner"></div></div>
        </div>
        <!-- Today's events summary -->
        <div class="card">
          <div class="card-title">ğŸ“… Today's Events <button class="refresh-btn" onclick="loadBriefing(true)" title="Refresh">âŸ³</button></div>
          <div id="overview-cal"></div>
        </div>
        <!-- Important emails -->
        <div class="card">
          <div class="card-title">âš ï¸ Important Emails</div>
          <div id="overview-imp"></div>
        </div>
        <!-- Tasks summary -->
        <div class="card">
          <div class="card-title">âœ… Tasks Due</div>
          <div id="overview-tasks"></div>
        </div>
        <!-- Packages arriving today -->
        <div class="card" id="packages-today-card">
          <div class="card-title">ğŸ“¦ Arriving / Delivered Today <button class="refresh-btn" onclick="loadBriefing(true)" title="Refresh">âŸ³</button></div>
          <div id="overview-packages"></div>
        </div>
        <!-- LLM Usage -->
        <div class="card">
          <div class="card-title">ğŸ¤– LLM Usage Today</div>
          <div id="overview-usage"><div class="empty-state">Loadingâ€¦</div></div>
        </div>
        <!-- AWS Cost -->
        <div class="card">
          <div class="card-title">â˜ï¸ AWS Cost <button class="refresh-btn" onclick="loadAwsCost(true)" title="Refresh AWS cost">âŸ³</button></div>
          <div id="overview-aws-cost"><div class="empty-state">Loadingâ€¦</div></div>
        </div>
      </div>

      <!-- Calendar Tab -->
      <div class="panel" id="panel-calendar">
        <div class="card">
          <div class="card-title">ğŸ“… Today <button class="refresh-btn" onclick="loadBriefing(true)">âŸ³</button></div>
          <div id="cal-today"></div>
        </div>
      </div>

      <!-- Tasks Tab -->
      <div class="panel" id="panel-tasks">
        <div class="card">
          <div class="card-title">âœ… Google Tasks <button class="refresh-btn" onclick="loadBriefing(true)">âŸ³</button></div>
          <!-- List filter tabs -->
          <div id="task-list-tabs" style="display:flex;gap:6px;flex-wrap:wrap;margin-bottom:10px"></div>
          <div id="tasks-list"></div>
          <div style="margin-top:10px">
            <div style="display:flex;gap:6px;flex-wrap:wrap">
              <input id="new-task-input" class="topic-input" placeholder="Add taskâ€¦" style="font-size:12px;padding:6px 10px;flex:1;min-width:0" />
              <select id="new-task-list" class="topic-input" style="font-size:12px;padding:6px 8px;cursor:pointer;max-width:130px">
                <option value="">Default list</option>
              </select>
              <button class="btn-primary" style="padding:6px 12px;font-size:12px" onclick="addTask()">Add</button>
            </div>
          </div>
        </div>
      </div>

      <!-- Email Tab -->
      <div class="panel" id="panel-email">
        <div class="card">
          <div class="card-title">ğŸ“§ Unread Emails <button class="refresh-btn" onclick="loadBriefing(true)">âŸ³</button></div>
          <div id="email-list"></div>
        </div>
      </div>

      <!-- News Tab -->
      <div class="panel" id="panel-news">
        <div class="card">
          <div class="card-title">ğŸ“° Morning News <button class="refresh-btn" onclick="loadBriefing(true)">âŸ³</button></div>
          <div id="news-list"></div>
        </div>
      </div>

      <!-- Reminders Tab -->
      <div class="panel" id="panel-reminders">
        <div class="card">
          <div class="card-title">ğŸ”” Reminders <button class="refresh-btn" onclick="loadReminders()">âŸ³</button></div>
          <div id="reminders-list"><div class="spinner"></div></div>
          <!-- Add reminder form -->
          <div style="margin-top:12px;padding-top:12px;border-top:1px solid var(--border)">
            <div style="font-size:12px;font-weight:600;color:var(--muted);margin-bottom:8px;text-transform:uppercase;letter-spacing:.05em">New Reminder</div>
            <input id="rem-title" class="topic-input" placeholder="e.g. Pay Amex bill" style="width:100%;margin-bottom:6px" />
            <div style="display:grid;grid-template-columns:1fr 1fr;gap:6px;margin-bottom:6px">
              <select id="rem-freq" class="topic-input" style="cursor:pointer" onchange="updateReminderForm()">
                <option value="monthly">Monthly</option>
                <option value="weekly">Weekly</option>
                <option value="daily">Daily</option>
                <option value="yearly">Yearly</option>
              </select>
              <input id="rem-time" type="time" class="topic-input" value="09:00" />
            </div>
            <div id="rem-day-row" style="display:grid;grid-template-columns:1fr 1fr;gap:6px;margin-bottom:8px">
              <div>
                <div style="font-size:11px;color:var(--muted);margin-bottom:2px" id="rem-day-label">Day of month</div>
                <input id="rem-day" type="number" min="1" max="31" value="1" class="topic-input" style="width:100%" />
              </div>
              <div id="rem-month-col" style="display:none">
                <div style="font-size:11px;color:var(--muted);margin-bottom:2px">Month</div>
                <select id="rem-month" class="topic-input" style="cursor:pointer;width:100%">
                  <option value="1">January</option><option value="2">February</option><option value="3">March</option>
                  <option value="4">April</option><option value="5">May</option><option value="6">June</option>
                  <option value="7">July</option><option value="8">August</option><option value="9">September</option>
                  <option value="10">October</option><option value="11">November</option><option value="12">December</option>
                </select>
              </div>
            </div>
            <textarea id="rem-notes" class="topic-input" placeholder="Notes (optional)" rows="2" style="width:100%;resize:vertical;margin-bottom:8px"></textarea>
            <button class="btn-primary" style="width:100%;padding:8px" onclick="addReminder()">+ Add Reminder</button>
          </div>
        </div>
      </div>

      <!-- Packages Tab -->
      <div class="panel" id="panel-packages">
        <div class="card">
          <div class="card-title" style="display:flex;align-items:center;gap:8px;flex-wrap:wrap">
            ğŸ“¦ Package Tracking
            <select id="pkg-days-select" style="margin-left:4px;font-size:12px;padding:2px 6px;border-radius:6px;background:var(--surface);color:var(--text);border:1px solid var(--border)" onchange="loadPackages()">
              <option value="2">Last 2 days</option>
              <option value="7" selected>Last 7 days</option>
              <option value="14">Last 2 weeks</option>
              <option value="30">Last 30 days</option>
            </select>
            <button class="refresh-btn" onclick="loadPackages()">âŸ³</button>
          </div>
          <div id="packages-list"><div class="empty-state">Select a time range and click âŸ³ to scan shipping emails</div></div>
        </div>
      </div>

    </div>
  </aside>
</div><!-- #app -->

<!-- Toast container -->
<div id="toast-container"></div>

<!-- Notification history panel -->
<div id="notif-panel" style="display:none;position:fixed;top:52px;right:12px;width:320px;max-height:420px;overflow-y:auto;background:var(--surface);border:1px solid var(--border);border-radius:10px;box-shadow:0 8px 32px #0008;z-index:900;padding:10px">
  <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px">
    <span style="font-weight:700;font-size:13px">ğŸ”” Notifications</span>
    <button onclick="document.getElementById('notif-panel').style.display='none'" style="background:none;border:none;color:var(--muted);font-size:16px;cursor:pointer">âœ•</button>
  </div>
  <div id="notif-panel-list"><div style="color:var(--muted);font-size:12px;text-align:center;padding:20px 0">No notifications yet</div></div>
</div>

<!-- â”€â”€ Settings Modal â”€â”€ -->
<div id="settings-overlay">
  <div id="settings-modal">
    <h2>âš™ï¸ Settings</h2>
    <p class="subtitle">Customize your daily planner experience</p>

    <div class="setting-section">
      <div class="setting-label">ğŸ¤– Assistant Name</div>
      <input id="assistant-name-input" class="topic-input" placeholder="e.g. Aria, Max, Novaâ€¦" style="width:100%" />
      <div style="font-size:11px;color:var(--muted);margin-top:5px">Shown in the chat header and used to greet you.</div>
    </div>

    <div class="setting-section">
      <div class="setting-label">ğŸ”Š Voice</div>
      <select id="voice-select" class="topic-input" style="width:100%;cursor:pointer">
        <option value="">Loading voicesâ€¦</option>
      </select>
      <div style="display:flex;gap:8px;margin-top:8px">
        <input id="voice-rate" type="range" min="0.6" max="1.6" step="0.05" style="flex:1;accent-color:var(--accent)" />
        <span style="font-size:12px;color:var(--muted);min-width:70px" id="voice-rate-label">Speed: 1.05Ã—</span>
        <button class="btn-secondary" style="padding:5px 12px;font-size:12px" onclick="previewVoice()">â–¶ Preview</button>
      </div>
    </div>

    <div class="setting-section">
      <div class="setting-label">ğŸ“° News Topics</div>
      <div class="topic-list" id="topic-list"></div>
      <button class="add-topic-btn" onclick="addTopicRow()">+ Add topic</button>
    </div>

    <div class="setting-section">
      <div class="setting-label">ğŸ“ˆ Briefing Schedule</div>
      <div style="display:grid;grid-template-columns:1fr 1fr;gap:12px;margin-top:4px">
        <div>
          <div style="font-size:12px;color:var(--muted);margin-bottom:4px">â˜€ï¸ Morning Briefing</div>
          <input id="morning-time-input" type="time" class="topic-input" style="width:100%" value="07:00" />
        </div>
        <div>
          <div style="font-size:12px;color:var(--muted);margin-bottom:4px">ğŸŒ™ Evening Briefing</div>
          <input id="evening-time-input" type="time" class="topic-input" style="width:100%" value="17:00" />
        </div>
      </div>
      <div style="font-size:11px;color:var(--muted);margin-top:5px">Times are in your local timezone (America/New_York).</div>
    </div>

    <div class="setting-section">
      <div class="setting-label">â­ VIP Senders</div>
      <div class="topic-list" id="vip-list"></div>
      <button class="add-topic-btn" onclick="addVipRow()">+ Add VIP sender</button>
      <div style="font-size:11px;color:var(--muted);margin-top:5px">Enter email addresses or domains (e.g. boss@company.com or @company.com). Youâ€™ll get a push notification when they email you.</div>
    </div>

    <div class="setting-section">
      <div class="setting-label">ğŸ” Highlight Keywords</div>
      <div class="topic-list" id="keyword-list"></div>
      <button class="add-topic-btn" onclick="addKeywordRow()">+ Add keyword</button>
      <div style="font-size:11px;color:var(--muted);margin-top:5px">Emails matching these keywords in subject or body will be highlighted with a green ğŸŸ¢ badge.</div>
    </div>

    <div class="setting-section">
      <div class="setting-label">â˜ï¸ AWS Monthly Cost Threshold</div>
      <div style="display:flex;align-items:center;gap:10px;margin-top:4px">
        <span style="font-size:14px">$</span>
        <input id="aws-cost-threshold-input" type="number" min="1" step="1" class="topic-input" style="width:100px" placeholder="50" />
        <span style="font-size:12px;color:var(--muted)">per month</span>
      </div>
      <div style="font-size:11px;color:var(--muted);margin-top:5px">The budget bar on the AWS Cost card turns yellow at 75% and red when exceeded.</div>
    </div>

    <div class="setting-section">
      <div class="setting-label">â„¹ï¸ Active Accounts</div>
      <div id="accounts-info" style="font-size:13px;color:var(--muted);line-height:1.8"></div>
    </div>

    <div class="modal-footer">
      <button class="btn-secondary" onclick="closeSettings()">Cancel</button>
      <button class="btn-primary" onclick="saveSettings()">Save Changes</button>
    </div>
  </div>
</div>

<script>
const USER_ID = 'web-user';
let briefingData = null;
let tasksData = [];

// â”€â”€ Auth token: capture from URL after login, persist to localStorage â”€â”€â”€â”€â”€
(function() {
  const params = new URLSearchParams(location.search);
  const tok = params.get('tok');
  if (tok) {
    localStorage.setItem('authToken', tok);
    // Clean the token out of the URL bar without a page reload
    history.replaceState({}, '', location.pathname);
  }
})();

// â”€â”€ Patch fetch to always send the auth token header â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const _origFetch = window.fetch.bind(window);
window.fetch = function(input, init = {}) {
  const tok = localStorage.getItem('authToken');
  if (tok) {
    init.headers = Object.assign({ 'X-Auth-Token': tok }, init.headers || {});
  }
  return _origFetch(input, init);
};

// â”€â”€ Clock â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function updateClock() {
  const now = new Date();
  document.getElementById('clock').textContent = now.toLocaleDateString('en-US', {
    weekday: 'long', month: 'long', day: 'numeric'
  }) + '  ' + now.toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit' });
}
updateClock();
setInterval(updateClock, 1000);

// â”€â”€ Tab switching â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function switchTab(name) {
  document.querySelectorAll('.rtab').forEach(t => t.classList.toggle('active', t.dataset.panel === name));
  document.querySelectorAll('.panel').forEach(p => p.classList.toggle('active', p.id === 'panel-' + name));
  if (name === 'reminders') loadReminders();
  if (name === 'packages') loadPackages();
}

// â”€â”€ Markdown renderer â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function escapeHtml(s) {
  return s.replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;');
}
function renderMarkdown(text) {
  const links = [];
  let html = text.replace(/\[([^\]]+)\]\((https?:\/\/[^)]+)\)/g, (_, label, url) => {
    links.push(`<a href="${url}" target="_blank" rel="noopener">${escapeHtml(label)}</a>`);
    return `\x00L${links.length-1}\x00`;
  });
  html = escapeHtml(html);
  html = html.replace(/\x00L(\d+)\x00/g, (_, i) => links[+i]);
  html = html.replace(/\*\*([^*]+)\*\*/g, '<strong>$1</strong>');
  html = html.replace(/`([^`]+)`/g, '<code>$1</code>');
  html = html.replace(/\n/g, '<br>');
  return html;
}
function stripMd(text) {
  return text
    .replace(/\[([^\]]+)\]\([^)]+\)/g, '$1')   // markdown links â†’ label only
    .replace(/\*\*([^*]+)\*\*/g, '$1')           // bold
    .replace(/`([^`]+)`/g, '$1')                 // inline code
    .replace(/\[[^\]]*\]/g, '')                  // [anything in brackets]
    .replace(/\([^)]*\)/g, '')                   // (anything in parens)
    .replace(/<[^>]*>/g, '')                     // <anything in angle brackets>
    .replace(/[\u{1F000}-\u{1FFFF}]/gu, '')      // emoji (supplementary plane: ğŸµğŸ ğŸ§ ğŸ¶ etc)
    .replace(/[\u2600-\u27BF]/gu, '')             // Misc symbols, Dingbats, arrows (â˜€ï¸âœ…ğŸ”” etc)
    .replace(/[\u2300-\u23FF]/gu, '')             // Misc Technical (â°â³ etc)
    .replace(/[\u25A0-\u25FF]/gu, '')             // Geometric shapes
    .replace(/[\u2700-\u27BF]/gu, '')             // Dingbats
    .replace(/[\uFE00-\uFE0F]/gu, '')             // variation selectors (invisible ï¸ suffix)
    .replace(/[\u200B-\u200D\uFEFF]/gu, '')       // zero-width chars
    .replace(/[ \t]{2,}/g, ' ')                   // collapse extra spaces (preserve newlines)
    .trim();
}

// â”€â”€ Chat bubbles â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const chat = document.getElementById('chat');

function addBubble(role, text) {
  const row = document.createElement('div');
  row.className = 'msg-row' + (role === 'user' ? ' user' : '');
  const label = document.createElement('div');
  label.className = role === 'user' ? 'msg-label' : 'msg-label msg-label-agent';
  label.textContent = role === 'user' ? 'You' : (localStorage.getItem('assistantName') || 'Assistant');
  const bubble = document.createElement('div');
  bubble.className = 'bubble ' + role;
  if (role === 'agent') bubble.innerHTML = renderMarkdown(text);
  else bubble.textContent = text;
  row.appendChild(label);
  row.appendChild(bubble);
  chat.appendChild(row);
  chat.scrollTop = chat.scrollHeight;
  return bubble;
}

function addThinking() {
  const row = document.createElement('div');
  row.className = 'msg-row';
  const label = document.createElement('div');
  label.className = 'msg-label msg-label-agent';
  label.textContent = localStorage.getItem('assistantName') || 'Assistant';
  const bubble = document.createElement('div');
  bubble.className = 'bubble thinking';
  bubble.innerHTML = '<span class="dots"><span>â—</span><span>â—</span><span>â—</span></span>';
  row.appendChild(label);
  row.appendChild(bubble);
  chat.appendChild(row);
  chat.scrollTop = chat.scrollHeight;
  return row;
}

// â”€â”€ Send message â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const textInput = document.getElementById('textInput');
const sendBtn   = document.getElementById('sendBtn');

async function sendText(msg, silent = false) {
  if (!msg.trim()) return;
  textInput.value = '';
  if (!silent) addBubble('user', msg);
  const thinking = addThinking();
  sendBtn.disabled = true;

  try {
    const res = await fetch('/voice-chat', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ text: msg, userId: USER_ID }),
    });
    if (res.status === 401) {
      thinking.remove();
      addBubble('agent', 'ğŸ”’ Session expired â€” redirecting to loginâ€¦');
      setTimeout(() => window.location.href = '/login', 1500);
      return;
    }
    const data = await res.json();
    thinking.remove();
    const reply = data.reply || data.error || 'No response';
    addBubble('agent', reply);
    speakText(stripMd(reply));
    // Refresh widgets after AI actions
    setTimeout(() => loadBriefing(false), 1200);
    // If the agent set/deleted a reminder, refresh the reminders list & badge immediately
    if (/reminder|remind/i.test(msg) || /reminder|remind/i.test(reply)) {
      setTimeout(() => loadReminders(), 500);
    }
  } catch (e) {
    thinking.remove();
    addBubble('agent', 'âš ï¸ Network error: ' + e.message);
  } finally {
    sendBtn.disabled = false;
    textInput.focus();
  }
}

sendBtn.addEventListener('click', () => sendText(textInput.value));
textInput.addEventListener('keydown', e => { if (e.key === 'Enter' && !e.shiftKey) { e.preventDefault(); sendText(textInput.value); } });

function sendQuick(msg) {
  textInput.value = msg;
  // If ends with space, just focus for user to type more
  if (msg.endsWith(' ')) { textInput.focus(); return; }
  sendText(msg);
}
function focusInput(prefix) {
  textInput.value = prefix;
  textInput.focus();
  textInput.setSelectionRange(prefix.length, prefix.length);
}

// â”€â”€ TTS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
let ttsEnabled = localStorage.getItem('ttsEnabled') !== 'false';
function updateMuteBtn() {
  const btn = document.getElementById('muteBtn');
  if (!btn) return;
  if (ttsEnabled) {
    btn.textContent = 'ğŸ”Š Voice';
    btn.classList.remove('active');
    btn.title = 'Click to mute voice reading';
  } else {
    btn.textContent = 'ğŸ”‡ Muted';
    btn.classList.add('active');
    btn.title = 'Click to enable voice reading';
  }
}
document.getElementById('muteBtn').addEventListener('click', () => {
  ttsEnabled = !ttsEnabled;
  localStorage.setItem('ttsEnabled', ttsEnabled);
  if (!ttsEnabled) window.speechSynthesis?.cancel();
  updateMuteBtn();
});
updateMuteBtn();

// Female-first preference order for default voice selection
const FEMALE_VOICE_PREFS = [
  'Google US English',       // Chrome on desktop (female by default)
  'Microsoft Aria',          // Edge â€“ female
  'Microsoft Jenny',         // Edge â€“ female
  'Microsoft Zira',          // Windows â€“ female
  'Samantha',                // macOS/iOS â€“ female
  'Karen',                   // macOS/iOS â€“ female
  'Victoria',                // macOS â€“ female
  'Moira',                   // macOS â€“ female
];

let _voicesReady = false;
let _voicesCache = [];

function getVoices() {
  if (_voicesCache.length) return _voicesCache;
  _voicesCache = window.speechSynthesis?.getVoices() ?? [];
  return _voicesCache;
}

function pickDefaultVoice(voices) {
  for (const pref of FEMALE_VOICE_PREFS) {
    const v = voices.find(v => v.name.includes(pref));
    if (v) return v;
  }
  // Fallback: any en-US voice
  return voices.find(v => v.lang === 'en-US') ?? null;
}

if (window.speechSynthesis) {
  const load = () => {
    _voicesCache = window.speechSynthesis.getVoices();
    _voicesReady = _voicesCache.length > 0;
  };
  load();
  window.speechSynthesis.addEventListener('voiceschanged', load);
}

function speakText(text) {
  if (!ttsEnabled || !window.speechSynthesis) return;
  window.speechSynthesis.cancel();
  const rate = parseFloat(localStorage.getItem('ttsRate') ?? '1.05');
  const savedVoice = localStorage.getItem('ttsVoice');
  const voices = getVoices();
  const v = savedVoice
    ? (voices.find(v => v.name === savedVoice) ?? pickDefaultVoice(voices))
    : pickDefaultVoice(voices);
  // Split on newlines so each line gets a natural pause between it
  const lines = text.split(/\n+/).map(l => l.trim()).filter(l => l.length > 0);
  if (lines.length === 0) return;
  lines.forEach(line => {
    const utt = new SpeechSynthesisUtterance(line);
    utt.lang = 'en-US';
    utt.rate = rate;
    utt.pitch = 1;
    if (v) utt.voice = v;
    window.speechSynthesis.speak(utt);
  });
}

function previewVoice() {
  const name = localStorage.getItem('assistantName') || 'Assistant';
  speakText(`Hi, I'm ${name}. Here is your daily briefing.`);
}

// â”€â”€ Mic â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const micBtn = document.getElementById('micBtn');
const voiceStatus = document.getElementById('voice-status');
const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
let recognition = null, isListening = false;

if (SpeechRecognition) {
  recognition = new SpeechRecognition();
  recognition.lang = 'en-US'; recognition.interimResults = true; recognition.continuous = false;
  recognition.onresult = e => {
    const transcript = Array.from(e.results).map(r => r[0].transcript).join('');
    if (e.results[e.results.length-1].isFinal) { voiceStatus.textContent = ''; sendText(transcript); }
    else voiceStatus.textContent = 'ğŸ™ "' + transcript + '"';
  };
  recognition.onerror = e => {
    voiceStatus.textContent = e.error === 'not-allowed' && location.protocol === 'http:' ? 'âš ï¸ Mic requires HTTPS' : 'âš ï¸ ' + e.error;
    micBtn.style.background = 'var(--surface2)'; isListening = false;
  };
  recognition.onend = () => { micBtn.style.background = 'var(--surface2)'; isListening = false; voiceStatus.textContent = ''; };
} else {
  micBtn.disabled = true;
  micBtn.title = 'Voice input not supported in this browser';
  micBtn.style.opacity = '0.4';
  voiceStatus.style.display = 'none';
}

micBtn.addEventListener('click', () => {
  if (!recognition) return;
  if (isListening) { recognition.stop(); isListening = false; micBtn.style.background = 'var(--surface2)'; }
  else { window.speechSynthesis?.cancel(); recognition.start(); isListening = true; micBtn.style.background = 'var(--red)'; voiceStatus.textContent = 'ğŸ”´ Listeningâ€¦'; }
});

// â”€â”€ Clear chat â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function clearChat() {
  window.speechSynthesis?.cancel();
  await fetch('/voice-chat', { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({text:'/clear', userId: USER_ID}) });
  chat.innerHTML = '<div class="msg-row"><div class="bubble system">Conversation cleared.</div></div>';
}

// â”€â”€ Digest â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
document.getElementById('digestBtn').addEventListener('click', async () => {
  const btn = document.getElementById('digestBtn');
  btn.textContent = 'ğŸ“§ Sendingâ€¦';
  try {
    const res = await fetch('/send-digest', { method: 'POST' });
    const data = await res.json();
    showToast(data.ok ? 'ğŸ“§ Digest Sent!' : 'âŒ Failed', data.ok ? 'Morning briefing emailed.' : data.error);
  } finally { btn.textContent = 'ğŸ“§ Send Digest'; }
});

// â”€â”€ SSE notifications â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
let unread = 0;
const recentAlerts = [];

function addToNotifPanel(title, body) {
  recentAlerts.unshift({ title, body, time: new Date() });
  if (recentAlerts.length > 50) recentAlerts.pop();
  const list = document.getElementById('notif-panel-list');
  list.innerHTML = recentAlerts.map(a => `
    <div class="notif-item">
      <div class="notif-item-title">${escapeHtml(a.title)}</div>
      <div class="notif-item-body">${escapeHtml(a.body ?? '')}</div>
      <div class="notif-item-time">${a.time.toLocaleTimeString('en-US',{hour:'numeric',minute:'2-digit'})}</div>
    </div>`).join('');
}

function connectSSE() {
  const tok = localStorage.getItem('authToken');
  const es = new EventSource('/notifications' + (tok ? `?tok=${encodeURIComponent(tok)}` : ''));
  es.addEventListener('notification', e => {
    try {
      const n = JSON.parse(e.data);
      showToast(n.title, n.body, n.type === 'event_starting');
      addToNotifPanel(n.title, n.body);
    } catch {}
  });
  es.addEventListener('error', () => { es.close(); setTimeout(connectSSE, 5000); });
}
connectSSE();

let unreadNotifs = 0;

function showToast(title, body, urgent=false) {
  const t = document.createElement('div');
  t.className = 'toast' + (urgent?' urgent':'');
  t.innerHTML = `<div class="toast-title">${escapeHtml(title)}</div><div class="toast-body">${escapeHtml(body??'')}</div>`;
  t.addEventListener('click', () => t.remove());
  document.getElementById('toast-container').appendChild(t);
  if (Notification.permission === 'granted') {
    const n = new Notification(title, { body, icon: '/icons/icon-192.png', tag: title });
    n.onclick = () => { n.close(); window.focus(); };
  }
  unreadNotifs++;
  const b = document.getElementById('notifBadge');
  b.style.display = 'inline'; b.textContent = unreadNotifs > 9 ? '9+' : unreadNotifs;
  setTimeout(() => { t.style.animation = 'tOut .3s forwards'; setTimeout(() => t.remove(), 300); }, 5000);
}

// â”€â”€ Load briefing & render widgets â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function loadBriefing(forceRefresh=false) {
  try {
    const url = forceRefresh ? '/api/briefing?refresh=1' : '/api/briefing';
    const res = await fetch(url);
    if (res.status === 401) { window.location.href = '/login'; return; }
    briefingData = await res.json();
    const ts = briefingData._fetchedAt ? new Date(briefingData._fetchedAt) : new Date();
    const el = document.getElementById('last-updated');
    if (el) el.textContent = 'Updated ' + ts.toLocaleTimeString('en-US', { hour: 'numeric', minute: '2-digit' });
    renderWidgets();
  } catch(e) { console.warn('Briefing load error:', e); }
}

function weatherIcon(condition) {
  const c = (condition||'').toLowerCase();
  if (c.includes('thunder')) return 'â›ˆ';
  if (c.includes('snow')) return 'â„ï¸';
  if (c.includes('rain') || c.includes('drizzle')) return 'ğŸŒ§';
  if (c.includes('cloud') || c.includes('overcast')) return 'â˜ï¸';
  if (c.includes('fog') || c.includes('mist')) return 'ğŸŒ«';
  if (c.includes('wind')) return 'ğŸ’¨';
  if (c.includes('partly')) return 'â›…';
  return 'â˜€ï¸';
}

function renderWidgets() {
  if (!briefingData) return;
  const { weather, calendar, emails, importantEmails, googleTasks, news, llmUsage, suggestions, packages } = briefingData;

  // â”€â”€ Proactive Suggestions Banner â”€â”€
  const banner = document.getElementById('suggestions-banner');
  const sugList = document.getElementById('suggestions-list');
  if (suggestions && suggestions.length > 0 && !banner.dataset.dismissed) {
    sugList.innerHTML = suggestions.map(s => `<div class="sug-item">${escapeHtml(s)}</div>`).join('');
    banner.style.display = 'block';
  } else {
    banner.style.display = 'none';
  }

  // â”€â”€ Packages arriving today (overview card) â”€â”€
  const pkgCard = document.getElementById('packages-today-card');
  const pkgEl   = document.getElementById('overview-packages');
  if (packages && packages.length > 0) {
    pkgCard.style.display = '';
    pkgEl.innerHTML = packages.map(p => {
      const subjectLower = (p.emailSubject||'').toLowerCase();
      const isDelivered = subjectLower.includes('delivered') || subjectLower.includes('delivery');
      const statusBadge = isDelivered
        ? `<span style="font-size:10px;font-weight:700;padding:2px 6px;border-radius:10px;background:#22c55e;color:#fff">âœ“ Delivered</span>`
        : `<span style="font-size:10px;font-weight:700;padding:2px 6px;border-radius:10px;background:#f59e0b;color:#fff">ğŸšš En Route</span>`;
      return `
      <div class="pkg-item">
        <div style="display:flex;align-items:center;gap:6px;flex-wrap:wrap">
          <span style="font-size:11px;font-weight:700;padding:2px 7px;border-radius:10px;background:var(--accent);color:#fff">${escapeHtml(p.carrier)}</span>
          ${statusBadge}
          ${p.trackingUrl && p.trackingUrl !== '#'
            ? `<a href="${escapeHtml(p.trackingUrl)}" target="_blank" rel="noopener" style="font-size:12px;font-weight:600;color:var(--accent2)">${escapeHtml(p.trackingNumber)} â†—</a>`
            : `<span style="font-size:12px;color:var(--muted)">${escapeHtml(p.trackingNumber)}</span>`}
        </div>
        <div class="pkg-subject" style="margin-top:3px">${escapeHtml(p.emailSubject)}</div>
        <div style="font-size:10px;color:var(--muted);margin-top:1px">${escapeHtml(p.emailFrom)}</div>
      </div>`;
    }).join('');
  } else {
    // Hide card entirely when no packages arriving today
    pkgCard.style.display = 'none';
  }

  // â”€â”€ Weather â”€â”€
  const wb = document.getElementById('weather-body');
  if (weather) {
    wb.innerHTML = `
      <div class="weather-main">
        <div class="weather-icon">${weatherIcon(weather.condition)}</div>
        <div>
          <div class="weather-temp">${weather.temperatureF}<span>Â°F</span></div>
          <div class="weather-desc">${escapeHtml(weather.condition||'')} Â· Feels ${weather.feelsLikeF}Â°F</div>
        </div>
      </div>
      <div class="weather-meta">
        <div class="weather-meta-item">ğŸŒ¡ H:<strong>${weather.high}Â°</strong> L:<strong>${weather.low}Â°</strong></div>
        <div class="weather-meta-item">ğŸ’§ Rain <strong>${weather.precipChance}%</strong></div>
        <div class="weather-meta-item">ğŸŒ… <strong>${weather.sunrise||'â€“'}</strong></div>
        <div class="weather-meta-item">ğŸŒ‡ <strong>${weather.sunset||'â€“'}</strong></div>
        <div class="weather-meta-item">â˜€ï¸ UV <strong>${weather.uvIndex??'â€“'}</strong></div>
        <div class="weather-meta-item">ğŸ“ <strong>${escapeHtml(weather.location||'')}</strong></div>
      </div>`;
  } else {
    wb.innerHTML = '<div class="empty-state">Weather unavailable</div>';
  }

  // â”€â”€ Calendar (overview + tab) â”€â”€
  const calHtml = (events) => {
    if (!events || events.length === 0) return '<div class="empty-state">No events today ğŸ‰</div>';
    return events.map(e => `
      <div class="event-item">
        <div class="event-time">${escapeHtml(e.start)}${e.end ? 'â€“'+escapeHtml(e.end) : ''}</div>
        <div class="event-dot"></div>
        <div>
          <div class="event-title">${escapeHtml(e.title)}</div>
          ${e.location ? `<div class="event-loc">ğŸ“ ${escapeHtml(e.location)}</div>` : ''}
        </div>
      </div>`).join('');
  };
  document.getElementById('overview-cal').innerHTML = calHtml(calendar);
  document.getElementById('cal-today').innerHTML = calHtml(calendar);

  // â”€â”€ Important emails (overview) â”€â”€
  const ov_imp = document.getElementById('overview-imp');
  if (importantEmails && importantEmails.length > 0) {
    ov_imp.innerHTML = importantEmails.slice(0,4).map(e => `
      <div class="email-item" onclick="sendQuick('Get last email from ${e.from.replace(/"/g,'')}')">
        <div class="email-from"><span class="imp">âš ï¸</span><span class="acct">${escapeHtml(e.account)}</span> ${escapeHtml(e.from)}</div>
        <div class="email-subject">${escapeHtml(e.subject)}</div>
      </div>`).join('');
  } else {
    ov_imp.innerHTML = '<div class="empty-state">No important emails âœ…</div>';
  }

  // â”€â”€ Email list (tab) â”€â”€
  const emailHtml = (emails) => {
    if (!emails || emails.length === 0) return '<div class="empty-state">Inbox clear âœ…</div>';
    return emails.slice(0,15).map(e => `
      <div class="email-item${e.isVip ? ' email-vip' : e.isHighlighted ? ' email-hl' : ''}" onclick="sendQuick('Get last email from ${e.from.replace(/"/g,'')}')">
        <div class="email-from">
          ${e.isImportant ? '<span class="imp">âš ï¸</span>' : ''}
          ${e.isVip ? '<span class="vip-badge">â­ VIP</span>' : e.isHighlighted ? '<span class="hl-badge">ğŸŸ¢</span>' : ''}
          <span class="acct">${escapeHtml(e.account)}</span>
          ${escapeHtml(e.from)}
        </div>
        <div class="email-subject">${escapeHtml(e.subject)}</div>
        <div class="email-snippet">${escapeHtml(e.snippet||'')}</div>
      </div>`).join('');
  };
  document.getElementById('email-list').innerHTML = emailHtml(emails);

  // Email badge
  const ec = emails ? emails.length : 0;
  const eb = document.getElementById('emailBadge');
  if (ec > 0) { eb.textContent = ec; eb.style.display = 'inline'; } else { eb.style.display = 'none'; }

  // Today's Calendar badge
  const todayCount = calendar ? calendar.length : 0;
  const ctb = document.getElementById('calTodayBadge');
  if (todayCount > 0) { ctb.textContent = todayCount; ctb.style.display = 'inline'; } else { ctb.style.display = 'none'; }

  // This Week badge â€” fetch 7-day calendar count
  fetch('/api/calendar?days=7').then(r => r.json()).then(data => {
    const weekCount = (data.events || []).length;
    const cwb = document.getElementById('calWeekBadge');
    if (weekCount > 0) { cwb.textContent = weekCount; cwb.style.display = 'inline'; } else { cwb.style.display = 'none'; }
  }).catch(() => {});

  // â”€â”€ Tasks â”€â”€
  tasksData = googleTasks || [];
  renderTasks();

  const tc = tasksData.length;
  const tb = document.getElementById('taskBadge');
  if (tc > 0) { tb.textContent = tc; tb.style.display = 'inline'; } else { tb.style.display = 'none'; }

  // â”€â”€ Tasks overview â”€â”€
  const ov_tasks = document.getElementById('overview-tasks');
  const dueSoon = tasksData.filter(t => t.due).slice(0,3);
  if (dueSoon.length > 0) {
    ov_tasks.innerHTML = dueSoon.map(t => `
      <div class="task-item">
        <div class="task-check" onclick="completeTask('${t.id}','${t.listId}',this)"></div>
        <div>
          <div class="task-title">${escapeHtml(t.title)}</div>
          ${t.due ? `<div class="task-due">Due ${new Date(t.due).toLocaleDateString('en-US',{month:'short',day:'numeric'})}</div>` : ''}
        </div>
      </div>`).join('');
  } else if (tasksData.length > 0) {
    ov_tasks.innerHTML = tasksData.slice(0,3).map(t => `
      <div class="task-item">
        <div class="task-check" onclick="completeTask('${t.id}','${t.listId}',this)"></div>
        <div><div class="task-title">${escapeHtml(t.title)}</div></div>
      </div>`).join('');
  } else {
    ov_tasks.innerHTML = '<div class="empty-state">No tasks ğŸ‰</div>';
  }

  // â”€â”€ News â”€â”€
  renderNews(news);

  // â”€â”€ LLM Usage â”€â”€
  const usageEl = document.getElementById('overview-usage');
  if (llmUsage) {
    const cost = llmUsage.estimatedCostUSD || 0;
    const tokens = (llmUsage.totalTokens || 0).toLocaleString();
    const calls = llmUsage.calls || 0;
    const pct = Math.min(100, (cost / 0.50) * 100).toFixed(0); // % of $0.50/day threshold
    usageEl.innerHTML = `
      <div style="display:grid;grid-template-columns:1fr 1fr 1fr;gap:8px;text-align:center;margin-bottom:10px">
        <div style="background:var(--surface2);border-radius:6px;padding:8px">
          <div style="font-size:18px;font-weight:600;color:var(--accent)">${tokens}</div>
          <div style="font-size:10px;color:var(--muted);margin-top:2px">TOKENS</div>
        </div>
        <div style="background:var(--surface2);border-radius:6px;padding:8px">
          <div style="font-size:18px;font-weight:600;color:var(--accent2)">$${cost.toFixed(4)}</div>
          <div style="font-size:10px;color:var(--muted);margin-top:2px">EST. COST</div>
        </div>
        <div style="background:var(--surface2);border-radius:6px;padding:8px">
          <div style="font-size:18px;font-weight:600">${calls}</div>
          <div style="font-size:10px;color:var(--muted);margin-top:2px">API CALLS</div>
        </div>
      </div>
      <div style="font-size:10px;color:var(--muted)">
        <div style="display:flex;justify-content:space-between;margin-bottom:3px">
          <span>Daily spend</span><span>$${cost.toFixed(4)} / $0.50 threshold</span>
        </div>
        <div style="background:var(--surface2);border-radius:3px;height:5px;overflow:hidden">
          <div style="background:${cost < 0.25 ? 'var(--green,#3fb950)' : cost < 0.40 ? '#d29922' : 'var(--red,#f85149)'};height:100%;width:${pct}%;transition:width .4s"></div>
        </div>
        <div style="margin-top:6px">Prompt: ${(llmUsage.promptTokens||0).toLocaleString()} &nbsp;Â·&nbsp; Completion: ${(llmUsage.completionTokens||0).toLocaleString()}</div>
        <div style="margin-top:2px">Model: grok-3 &nbsp;Â·&nbsp; Resets at midnight</div>
      </div>`;
  } else {
    usageEl.innerHTML = '<div class="empty-state">No usage recorded yet</div>';
  }

  // â”€â”€ AWS Cost (loaded separately) â”€â”€
  loadAwsCost(false);
}

let awsCostLoaded = false;
async function loadAwsCost(forceRefresh) {
  const el = document.getElementById('overview-aws-cost');
  if (!el) return;
  if (!forceRefresh && awsCostLoaded) return;
  el.innerHTML = '<div class="empty-state">Loadingâ€¦</div>';
  try {
    const url = forceRefresh ? '/api/aws-cost?refresh=1' : '/api/aws-cost';
    const res = await fetch(url);
    const d = await res.json();
    if (!res.ok) {
      const hint = d.hint ? `<div style="margin-top:6px;font-size:10px;color:var(--muted)">${d.hint}</div>` : '';
      el.innerHTML = `<div class="empty-state" style="color:var(--red,#f85149)">${d.error || 'Error fetching AWS cost'}${hint}</div>`;
      return;
    }
    awsCostLoaded = true;
    const fmt = n => '$' + (n||0).toFixed(2);
    const mtd      = d.mtdTotalUSD || 0;
    const forecast = d.forecastTotalUSD;
    const yday     = d.yesterdayUSD || 0;
    const daily    = d.dailyAvgUSD || 0;
    const threshold = d.threshold || 50;
    const svcs     = (d.byService || []).slice(0, 5);
    const cachedNote = d.cached ? ' <span style="font-size:9px;color:var(--muted)">(cached)</span>' : '';

    // Progress bar: use forecast if available, else MTD
    const compareVal  = (forecast !== null && forecast !== undefined) ? forecast : mtd;
    const pct         = Math.min(100, (compareVal / threshold) * 100).toFixed(0);
    const barColor    = compareVal < threshold * 0.75 ? 'var(--green,#3fb950)'
                      : compareVal < threshold        ? '#d29922'
                      : 'var(--red,#f85149)';
    const overBudget  = compareVal >= threshold;

    el.innerHTML = `
      <div style="display:grid;grid-template-columns:1fr 1fr;gap:8px;text-align:center;margin-bottom:10px">
        <div style="background:var(--surface2);border-radius:6px;padding:8px">
          <div style="font-size:18px;font-weight:600;color:var(--accent)">${fmt(mtd)}</div>
          <div style="font-size:10px;color:var(--muted);margin-top:2px">MTD ACTUAL${cachedNote}</div>
        </div>
        <div style="background:var(--surface2);border-radius:6px;padding:8px">
          <div style="font-size:18px;font-weight:600;color:${overBudget ? 'var(--red,#f85149)' : 'var(--accent2)'}">${forecast !== null && forecast !== undefined ? fmt(forecast) : 'N/A'}</div>
          <div style="font-size:10px;color:var(--muted);margin-top:2px">MONTH FORECAST</div>
        </div>
      </div>
      <div style="font-size:10px;color:var(--muted);margin-bottom:4px">
        <div style="display:flex;justify-content:space-between">
          <span>${overBudget ? 'âš ï¸ Over budget!' : 'Budget'}</span>
          <span style="font-weight:600;color:${barColor}">${fmt(compareVal)} / ${fmt(threshold)}</span>
        </div>
        <div style="background:var(--surface2);border-radius:3px;height:6px;overflow:hidden;margin:4px 0">
          <div style="background:${barColor};height:100%;width:${pct}%;transition:width .4s"></div>
        </div>
      </div>
      <div style="font-size:11px;color:var(--muted);margin-bottom:8px">
        Yesterday: ${fmt(yday)} &nbsp;Â·&nbsp; Daily avg: ${fmt(daily)}/day
      </div>
      ${svcs.length ? `<div style="font-size:10px">
        <div style="font-weight:600;margin-bottom:4px;color:var(--muted)">TOP SERVICES</div>
        ${svcs.map(s => `<div style="display:flex;justify-content:space-between;padding:2px 0;border-bottom:1px solid var(--border,#30363d)">
          <span style="overflow:hidden;text-overflow:ellipsis;white-space:nowrap;max-width:70%">${s.service}</span>
          <span style="font-weight:600">${fmt(s.amountUSD)}</span></div>`).join('')}
      </div>` : ''}
      <div style="font-size:9px;color:var(--muted);margin-top:6px">Period: ${d.periodStart} â†’ ${d.periodEnd}</div>`;
  } catch (e) {
    if (el) el.innerHTML = `<div class="empty-state" style="color:var(--red,#f85149)">Failed to load: ${e.message}</div>`;
  }
}

let activeTaskList = 'all'; // 'all' or a listTitle

function renderTasks() {
  const el = document.getElementById('tasks-list');
  if (!tasksData || tasksData.length === 0) { el.innerHTML = '<div class="empty-state">No tasks ğŸ‰</div>'; return; }

  // Build list tabs
  const tabsEl = document.getElementById('task-list-tabs');
  const lists = ['all', ...new Set(tasksData.map(t => t.listTitle).filter(Boolean))];
  tabsEl.innerHTML = lists.map(l => {
    const count = l === 'all' ? tasksData.length : tasksData.filter(t => t.listTitle === l).length;
    const active = l === activeTaskList;
    return `<button onclick="setTaskListFilter('${escapeHtml(l)}')"
      style="padding:3px 10px;font-size:11px;border-radius:20px;border:1px solid var(--border);cursor:pointer;
             background:${active ? 'var(--accent)' : 'var(--surface)'};color:${active ? '#fff' : 'var(--text)'}"
    >${l === 'all' ? 'All' : escapeHtml(l)} <span style="opacity:0.7">${count}</span></button>`;
  }).join('');

  // Filter tasks
  const filtered = activeTaskList === 'all'
    ? tasksData
    : tasksData.filter(t => t.listTitle === activeTaskList);

  if (filtered.length === 0) { el.innerHTML = '<div class="empty-state">No tasks in this list ğŸ‰</div>'; return; }

  // Group by list title when showing All
  const grouped = new Map();
  for (const t of filtered) {
    const key = t.listTitle || 'Tasks';
    if (!grouped.has(key)) grouped.set(key, []);
    grouped.get(key).push(t);
  }

  let html = '';
  for (const [listName, tasks] of grouped) {
    if (activeTaskList === 'all' && grouped.size > 1) {
      html += `<div style="font-size:11px;font-weight:600;color:var(--muted);text-transform:uppercase;letter-spacing:.05em;margin:8px 0 4px">${escapeHtml(listName)}</div>`;
    }
    html += tasks.map(t => `
      <div class="task-item" id="task-${t.id}">
        <div class="task-check" onclick="completeTask('${t.id}','${t.listId}',this)"></div>
        <div style="flex:1;min-width:0">
          <div class="task-title">${escapeHtml(t.title)}</div>
          ${t.due ? `<div class="task-due">Due ${new Date(t.due).toLocaleDateString('en-US',{month:'short',day:'numeric'})}</div>` : ''}
        </div>
      </div>`).join('');
  }
  el.innerHTML = html;
}

function setTaskListFilter(list) {
  activeTaskList = list;
  renderTasks();
}

// Load task lists into the Add Task selector
async function loadTaskLists() {
  try {
    const res = await fetch('/api/task-lists');
    const data = await res.json();
    const sel = document.getElementById('new-task-list');
    if (data.lists && data.lists.length) {
      sel.innerHTML = data.lists.map(l =>
        `<option value="${escapeHtml(l.id)}">${escapeHtml(l.title)}</option>`
      ).join('');
    }
  } catch (e) { /* silently ignore */ }
}

// â”€â”€ Recurring Reminders â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const FREQ_LABELS = { daily: 'Daily', weekly: 'Weekly', monthly: 'Monthly', yearly: 'Yearly' };
const DAY_NAMES   = ['Sun','Mon','Tue','Wed','Thu','Fri','Sat'];
const MONTH_NAMES = ['','Jan','Feb','Mar','Apr','May','Jun','Jul','Aug','Sep','Oct','Nov','Dec'];

function updateReminderForm() {
  const freq = document.getElementById('rem-freq').value;
  const dayRow = document.getElementById('rem-day-row');
  const dayLabel = document.getElementById('rem-day-label');
  const monthCol = document.getElementById('rem-month-col');
  const dayInput = document.getElementById('rem-day');

  if (freq === 'daily') {
    dayRow.style.display = 'none';
    return;
  }
  dayRow.style.display = 'grid';
  if (freq === 'weekly') {
    dayLabel.textContent = 'Day of week';
    dayInput.type = 'number'; dayInput.min = '0'; dayInput.max = '6'; dayInput.value = '1';
    dayInput.placeholder = '0=Sun â€¦ 6=Sat';
    monthCol.style.display = 'none';
  } else if (freq === 'monthly') {
    dayLabel.textContent = 'Day of month';
    dayInput.type = 'number'; dayInput.min = '1'; dayInput.max = '31'; dayInput.value = '1';
    dayInput.placeholder = '1-31';
    monthCol.style.display = 'none';
  } else if (freq === 'yearly') {
    dayLabel.textContent = 'Day of month';
    dayInput.type = 'number'; dayInput.min = '1'; dayInput.max = '31'; dayInput.value = '1';
    monthCol.style.display = 'block';
  }
}
updateReminderForm(); // init on load

// Returns the next Date a reminder fires on or after `from`, or null if > 31 days away
function nextOccurrence(r, from) {
  const [h, m] = r.time.split(':').map(Number);
  const d = new Date(from);
  d.setSeconds(0, 0);

  if (r.frequency === 'daily') {
    const t = new Date(from);
    t.setHours(h, m, 0, 0);
    if (t <= from) t.setDate(t.getDate() + 1);
    return t;
  }

  if (r.frequency === 'weekly') {
    const target = r.dayOfWeek ?? 0;
    const t = new Date(from);
    t.setHours(h, m, 0, 0);
    const diff = (target - t.getDay() + 7) % 7;
    t.setDate(t.getDate() + (diff === 0 && t <= from ? 7 : diff));
    return t;
  }

  if (r.frequency === 'monthly') {
    const dom = r.dayOfMonth ?? 1;
    for (let i = 0; i < 2; i++) {
      const t = new Date(from.getFullYear(), from.getMonth() + i, dom, h, m, 0, 0);
      if (t > from) return t;
    }
    return null;
  }

  if (r.frequency === 'yearly') {
    const dom = r.dayOfMonth ?? 1;
    const mon = (r.month ?? 1) - 1;
    for (let i = 0; i < 2; i++) {
      const t = new Date(from.getFullYear() + i, mon, dom, h, m, 0, 0);
      if (t > from) return t;
    }
    return null;
  }

  if (r.frequency === 'once' && r.fireDate) {
    const [yr, mo, dy] = r.fireDate.split('-').map(Number);
    const t = new Date(yr, mo - 1, dy, h, m, 0, 0);
    return t > from ? t : null;
  }

  return null;
}

async function loadReminders() {
  const el = document.getElementById('reminders-list');
  try {
    const res = await fetch('/api/reminders');
    const data = await res.json();
    const all = data.reminders || [];
    if (all.length === 0) {
      el.innerHTML = '<div class="empty-state">No reminders yet.<br><small style="color:var(--muted)">Add one below or ask the agent.</small></div>';
      return;
    }

    const now = new Date();
    const cutoff = new Date(now.getTime() + 31 * 24 * 60 * 60 * 1000);

    // Attach next occurrence, filter to within 31 days, sort by soonest
    const upcoming = all
      .map(r => ({ r, next: nextOccurrence(r, now) }))
      .filter(({ next }) => next && next <= cutoff)
      .sort((a, b) => a.next - b.next);

    if (upcoming.length === 0) {
      el.innerHTML = '<div class="empty-state">No reminders due in the next month.<br><small style="color:var(--muted)">All reminders are shown when they are within 30 days.</small></div>';
      return;
    }

    const todayStr = now.toDateString();
    const tomorrowStr = new Date(now.getTime() + 86400000).toDateString();

    // Update badge with count of reminders due today or tomorrow
    const soonCount = upcoming.filter(({ next }) => next.toDateString() === todayStr || next.toDateString() === tomorrowStr).length;
    const badgeEl = document.getElementById('reminderBadge');
    if (badgeEl) {
      if (soonCount > 0) { badgeEl.textContent = soonCount; badgeEl.style.display = ''; }
      else { badgeEl.style.display = 'none'; }
    }

    el.innerHTML = upcoming.map(({ r, next }) => {
      const schedule = describeReminderJS(r);
      const color = r.active ? 'var(--green,#3fb950)' : 'var(--muted)';
      // Friendly "due in" label
      const diffMs = next - now;
      const diffDays = Math.floor(diffMs / 86400000);
      let whenLabel;
      if (next.toDateString() === todayStr) whenLabel = 'âš¡ Today';
      else if (next.toDateString() === tomorrowStr) whenLabel = 'ğŸ“… Tomorrow';
      else whenLabel = `ğŸ“… In ${diffDays} day${diffDays !== 1 ? 's' : ''}`;

      return `<div class="task-item" style="align-items:flex-start" id="rem-${r.id}">
        <div style="font-size:18px;line-height:1;padding-top:2px">ğŸ””</div>
        <div style="flex:1;min-width:0">
          <div style="font-size:13px;font-weight:600">${escapeHtml(r.title)}</div>
          <div style="font-size:11px;color:${color};margin-top:2px">${escapeHtml(schedule)}</div>
          <div style="font-size:11px;color:var(--accent2,#e3b341);margin-top:1px">${whenLabel} Â· ${next.toLocaleTimeString('en-US',{hour:'numeric',minute:'2-digit'})}</div>
          ${r.notes ? `<div style="font-size:11px;color:var(--muted);margin-top:2px">${escapeHtml(r.notes)}</div>` : ''}
        </div>
        <button onclick="deleteReminder('${r.id}')" style="background:none;border:none;cursor:pointer;color:var(--muted);font-size:14px;padding:0 4px" title="Delete">âœ•</button>
      </div>`;
    }).join('');
  } catch (e) {
    el.innerHTML = `<div class="empty-state" style="color:var(--red)">Error loading reminders</div>`;
  }
}

function describeReminderJS(r) {
  const [h, m] = r.time.split(':').map(Number);
  const ampm = h >= 12 ? 'PM' : 'AM';
  const h12 = h % 12 === 0 ? 12 : h % 12;
  const ts = `${h12}:${String(m).padStart(2,'0')} ${ampm}`;
  if (r.frequency === 'once')    return r.fireDate ? `Once on ${r.fireDate} at ${ts}` : `Once at ${ts}`;
  if (r.frequency === 'daily')   return `Every day at ${ts}`;
  if (r.frequency === 'weekly')  return `Every ${['Sunday','Monday','Tuesday','Wednesday','Thursday','Friday','Saturday'][r.dayOfWeek ?? 0]} at ${ts}`;
  if (r.frequency === 'monthly') return `Every month on the ${r.dayOfMonth} at ${ts}`;
  if (r.frequency === 'yearly')  return `Every year on ${MONTH_NAMES[r.month ?? 1]} ${r.dayOfMonth} at ${ts}`;
  return ts;
}

async function addReminder() {
  const title = document.getElementById('rem-title').value.trim();
  if (!title) { showToast('âŒ', 'Enter a reminder title'); return; }
  const freq  = document.getElementById('rem-freq').value;
  const time  = document.getElementById('rem-time').value;
  const day   = parseInt(document.getElementById('rem-day').value);
  const month = parseInt(document.getElementById('rem-month').value);
  const notes = document.getElementById('rem-notes').value.trim();

  const body = { title, frequency: freq, time };
  if (freq === 'weekly')         body.dayOfWeek  = day;
  if (freq === 'monthly')        body.dayOfMonth = day;
  if (freq === 'yearly')       { body.dayOfMonth = day; body.month = month; }
  if (notes) body.notes = notes;

  try {
    const res = await fetch('/api/reminders', {
      method: 'POST', headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(body),
    });
    const data = await res.json();
    if (data.ok) {
      document.getElementById('rem-title').value = '';
      document.getElementById('rem-notes').value = '';
      showToast('ğŸ”” Reminder set', describeReminderJS(data.reminder));
      loadReminders();
    } else {
      showToast('âŒ Error', data.error || 'Could not add reminder');
    }
  } catch(e) { showToast('âŒ Error', e.message); }
}

async function deleteReminder(id) {
  try {
    const res = await fetch(`/api/reminders/${id}`, { method: 'DELETE' });
    const data = await res.json();
    if (data.ok) { showToast('ğŸ—‘ Removed', 'Reminder deleted'); loadReminders(); }
    else showToast('âŒ Error', data.error || 'Could not delete');
  } catch(e) { showToast('âŒ Error', e.message); }
}

async function completeTask(taskId, listId, el) {
  el.classList.add('done');
  try {
    const res = await fetch('/api/complete-task', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ taskId, listId }),
    });
    const data = await res.json();
    if (data.ok) {
      showToast('âœ… Task complete', 'Task marked as done');
      setTimeout(() => loadBriefing(false), 600);
    } else {
      el.classList.remove('done');
      showToast('âŒ Error', data.error || 'Could not complete task');
    }
  } catch(e) {
    el.classList.remove('done');
    showToast('âŒ Error', e.message);
  }
}

async function addTask() {
  const input = document.getElementById('new-task-input');
  const listSel = document.getElementById('new-task-list');
  const title = input.value.trim();
  if (!title) return;
  input.value = '';
  try {
    const body = { title, listId: listSel.value || undefined };
    const res = await fetch('/api/create-task', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(body),
    });
    const data = await res.json();
    if (data.ok) {
      showToast('âœ… Task added', title);
      setTimeout(() => loadBriefing(false), 600);
    } else {
      showToast('âŒ Error', data.error || 'Could not add task');
    }
  } catch(e) {
    showToast('âŒ Error', e.message);
  }
}
document.getElementById('new-task-input').addEventListener('keydown', e => { if(e.key === 'Enter') addTask(); });

function renderNews(news) {
  const el = document.getElementById('news-list');
  if (!news || news.length === 0) { el.innerHTML = '<div class="empty-state">No news loaded</div>'; return; }
  el.innerHTML = news.map(n => `
    <div class="news-topic">${escapeHtml(n.topic)}</div>
    ${n.articles.length === 0
      ? '<div class="empty-state" style="margin-bottom:8px">No articles</div>'
      : n.articles.map(a => `
        <div class="news-article">
          <a href="${a.url}" target="_blank" rel="noopener">${escapeHtml(a.title)}</a>
          <div class="news-source">${escapeHtml(a.source)} Â· ${a.publishedAt ? new Date(a.publishedAt).toLocaleDateString('en-US',{month:'short',day:'numeric'}) : ''}</div>
        </div>`).join('')
    }`).join('');
}

// â”€â”€ Package tracking â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function loadPackages() {
  const el = document.getElementById('packages-list');
  const daysBack = document.getElementById('pkg-days-select')?.value ?? '7';
  el.innerHTML = '<div class="spinner"></div>';
  try {
    const res = await fetch(`/api/packages?daysBack=${daysBack}`);
    const data = await res.json();
    const pkgs = data.packages || [];
    if (pkgs.length === 0) {
      el.innerHTML = `<div class="empty-state">ğŸ“¦ No shipping emails found in the last ${daysBack} days.<br><small style="color:var(--muted)">Scans UPS, FedEx, USPS, and Amazon shipping/delivery emails.</small></div>`;
      return;
    }
    // Group: arriving/delivered today first, then others
    const today = pkgs.filter(p => p.arrivingToday);
    const other = pkgs.filter(p => !p.arrivingToday);
    const renderPkg = (p) => {
      const subjectLower = (p.emailSubject||'').toLowerCase();
      const isDelivered = subjectLower.includes('delivered');
      const statusBadge = p.arrivingToday
        ? (isDelivered
            ? `<span style="font-size:10px;font-weight:700;padding:2px 6px;border-radius:10px;background:#22c55e;color:#fff">âœ“ Delivered</span>`
            : `<span style="font-size:10px;font-weight:700;padding:2px 6px;border-radius:10px;background:#f59e0b;color:#fff">ğŸšš Today</span>`)
        : (isDelivered
            ? `<span style="font-size:10px;font-weight:700;padding:2px 6px;border-radius:10px;background:#6b7280;color:#fff">âœ“ Delivered</span>`
            : `<span style="font-size:10px;font-weight:700;padding:2px 6px;border-radius:10px;background:#3b82f6;color:#fff">ğŸšš In Transit</span>`);
      const dateStr = p.emailDate ? new Date(p.emailDate).toLocaleDateString('en-US',{month:'short',day:'numeric',year:'numeric'}) : '';
      return `
      <div class="pkg-item">
        <div style="display:flex;align-items:center;gap:6px;flex-wrap:wrap">
          <span style="font-size:11px;font-weight:700;padding:2px 7px;border-radius:10px;background:var(--accent);color:#fff">${escapeHtml(p.carrier)}</span>
          ${statusBadge}
          ${p.trackingUrl && p.trackingUrl !== '#'
            ? `<a href="${escapeHtml(p.trackingUrl)}" target="_blank" rel="noopener" style="font-size:12px;font-weight:600;color:var(--accent2)">${escapeHtml(p.trackingNumber)} â†—</a>`
            : `<span style="font-size:12px;color:var(--muted)">${escapeHtml(p.trackingNumber)}</span>`}
        </div>
        <div class="pkg-subject" style="margin-top:3px">${escapeHtml(p.emailSubject)}</div>
        <div style="font-size:10px;color:var(--muted);margin-top:1px">${escapeHtml(p.emailFrom)} Â· ${dateStr}</div>
      </div>`;
    };
    let html = '';
    if (today.length > 0) {
      html += `<div style="font-size:11px;font-weight:700;color:var(--accent);margin:4px 0 6px;text-transform:uppercase;letter-spacing:.5px">ğŸ“¦ Today</div>`;
      html += today.map(renderPkg).join('');
    }
    if (other.length > 0) {
      if (today.length > 0) html += `<div style="margin:10px 0 6px;border-top:1px solid var(--border)"></div>`;
      html += `<div style="font-size:11px;font-weight:700;color:var(--muted);margin:4px 0 6px;text-transform:uppercase;letter-spacing:.5px">Recent (last ${daysBack}d)</div>`;
      html += other.map(renderPkg).join('');
    }
    el.innerHTML = html;
  } catch(e) {
    el.innerHTML = '<div class="empty-state" style="color:var(--red)">Error loading packages</div>';
  }
}

function dismissSuggestions() {
  const banner = document.getElementById('suggestions-banner');
  banner.style.display = 'none';
  banner.dataset.dismissed = '1';
}

// â”€â”€ Settings â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
document.getElementById('settingsBtn').addEventListener('click', openSettings);

async function openSettings() {
  const res = await fetch('/api/settings');
  const settings = await res.json();

  // Assistant name â€” prefer server value, fall back to localStorage
  const serverName = settings.assistantName || '';
  if (serverName) localStorage.setItem('assistantName', serverName);
  document.getElementById('assistant-name-input').value = serverName || localStorage.getItem('assistantName') || '';

  // Voice picker â€” wait for voices to be ready
  const sel = document.getElementById('voice-select');
  const savedVoice = localStorage.getItem('ttsVoice');
  const populateVoices = () => {
    const voices = getVoices();
    if (voices.length === 0) {
      sel.innerHTML = '<option value="">No voices found â€” try Chrome or Edge</option>';
      return;
    }
    const defaultVoice = savedVoice ?? (pickDefaultVoice(voices)?.name ?? '');
    sel.innerHTML = voices.map(v =>
      `<option value="${escapeHtml(v.name)}" ${v.name === defaultVoice ? 'selected' : ''}>${escapeHtml(v.name)} (${v.lang})</option>`
    ).join('');
    // If nothing was explicitly saved, persist the female default
    if (!savedVoice && defaultVoice) localStorage.setItem('ttsVoice', defaultVoice);
  };
  populateVoices();
  if (!_voicesReady) {
    window.speechSynthesis?.addEventListener('voiceschanged', populateVoices, { once: true });
  }

  // Speed slider
  const rateSlider = document.getElementById('voice-rate');
  const savedRate = parseFloat(localStorage.getItem('ttsRate') ?? '1.05');
  rateSlider.value = savedRate;
  document.getElementById('voice-rate-label').textContent = `Speed: ${savedRate.toFixed(2)}Ã—`;
  rateSlider.oninput = () => {
    document.getElementById('voice-rate-label').textContent = `Speed: ${parseFloat(rateSlider.value).toFixed(2)}Ã—`;
  };

  // Build topic rows
  const tl = document.getElementById('topic-list');
  tl.innerHTML = '';
  settings.newsTopics.forEach(t => addTopicRow(t));

  // VIP senders
  const vl = document.getElementById('vip-list');
  vl.innerHTML = '';
  (settings.vipSenders || []).forEach(v => addVipRow(v));

  // Filter keywords
  const kl = document.getElementById('keyword-list');
  kl.innerHTML = '';
  (settings.filterKeywords || []).forEach(k => addKeywordRow(k));

  // Briefing times
  if (settings.morningBriefingTime) document.getElementById('morning-time-input').value = settings.morningBriefingTime;
  if (settings.eveningBriefingTime) document.getElementById('evening-time-input').value = settings.eveningBriefingTime;

  // AWS cost threshold
  document.getElementById('aws-cost-threshold-input').value = settings.awsCostThreshold ?? 50;

  // Accounts info
  document.getElementById('accounts-info').innerHTML =
    settings.accounts.map(a => `âœ‰ï¸ <strong>${escapeHtml(a)}</strong> Gmail account`).join('<br>') +
    `<br>ğŸ• Timezone: <strong>${escapeHtml(settings.timezone)}</strong>` +
    (settings.digestEmail ? `<br>ğŸ“§ Digest to: <strong>${escapeHtml(settings.digestEmail)}</strong>` : '');
  document.getElementById('settings-overlay').classList.add('open');
}

function closeSettings() {
  document.getElementById('settings-overlay').classList.remove('open');
}

function addTopicRow(value='') {
  const row = document.createElement('div');
  row.className = 'topic-row';
  row.innerHTML = `<input class="topic-input" placeholder="e.g. Artificial Intelligence" value="${escapeHtml(value)}" />
    <button class="remove-btn" onclick="this.parentElement.remove()">âœ•</button>`;
  document.getElementById('topic-list').appendChild(row);
  if (!value) row.querySelector('input').focus();
}

function addVipRow(value='') {
  const row = document.createElement('div');
  row.className = 'topic-row';
  row.innerHTML = `<input class="topic-input" placeholder="e.g. boss@company.com" value="${escapeHtml(value)}" />
    <button class="remove-btn" onclick="this.parentElement.remove()">âœ•</button>`;
  document.getElementById('vip-list').appendChild(row);
  if (!value) row.querySelector('input').focus();
}

function addKeywordRow(value='') {
  const row = document.createElement('div');
  row.className = 'topic-row';
  row.innerHTML = `<input class="topic-input" placeholder="e.g. invoice, urgent, contract" value="${escapeHtml(value)}" />
    <button class="remove-btn" onclick="this.parentElement.remove()">âœ•</button>`;
  document.getElementById('keyword-list').appendChild(row);
  if (!value) row.querySelector('input').focus();
}

function applyAssistantName() {
  const name = localStorage.getItem('assistantName') || 'Assistant';
  document.getElementById('chat-title').textContent = name;
  const h = new Date().getHours();
  const g = h < 12 ? 'Good morning' : h < 17 ? 'Good afternoon' : 'Good evening';
  document.getElementById('chat-subtitle').textContent = `${g}! Ask ${name} anything about your day`;
  // Update all existing agent message labels in the chat
  document.querySelectorAll('.msg-label-agent').forEach(el => { el.textContent = name; });
}

async function saveSettings() {
  // Save assistant name
  const nameVal = document.getElementById('assistant-name-input').value.trim();
  if (nameVal) localStorage.setItem('assistantName', nameVal);
  else localStorage.removeItem('assistantName');

  // Save voice
  const voiceVal = document.getElementById('voice-select').value;
  if (voiceVal) localStorage.setItem('ttsVoice', voiceVal);
  else localStorage.removeItem('ttsVoice');

  // Save rate
  const rateVal = parseFloat(document.getElementById('voice-rate').value);
  localStorage.setItem('ttsRate', rateVal.toFixed(2));

  // Save news topics
  const topics = Array.from(document.querySelectorAll('#topic-list .topic-input'))
    .map(i => i.value.trim()).filter(Boolean);
  const vipSenders = Array.from(document.querySelectorAll('#vip-list .topic-input'))
    .map(i => i.value.trim()).filter(Boolean);
  const filterKeywords = Array.from(document.querySelectorAll('#keyword-list .topic-input'))
    .map(i => i.value.trim()).filter(Boolean);
  const morningTime = document.getElementById('morning-time-input').value;
  const eveningTime = document.getElementById('evening-time-input').value;
  const awsCostThreshold = parseFloat(document.getElementById('aws-cost-threshold-input').value) || 50;
  const res = await fetch('/api/settings', {
    method: 'POST', headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({ newsTopics: topics, morningBriefingTime: morningTime, eveningBriefingTime: eveningTime, vipSenders, filterKeywords, awsCostThreshold, assistantName: nameVal }),
  });
  const data = await res.json();
  if (data.ok) {
    applyAssistantName();
    showToast('âœ… Settings saved', nameVal ? `Assistant renamed to ${nameVal}` : 'Settings updated');
    closeSettings();
    awsCostLoaded = false; // force re-render with new threshold
    setTimeout(() => { loadBriefing(false); loadAwsCost(false); }, 300);
  }
}

// Sync assistantName from server on load so all devices stay in sync
fetch('/api/settings').then(r => r.json()).then(s => {
  if (s.assistantName) { localStorage.setItem('assistantName', s.assistantName); applyAssistantName(); }
}).catch(() => {});
// Apply on load
applyAssistantName();
// Load briefing data immediately on page open
loadBriefing(false);
// Load AWS cost card
loadAwsCost(false);
// Delay non-critical init calls so they don't compete with the briefing fetch
setTimeout(() => { loadTaskLists(); loadReminders(); }, 2000);
// Auto-trigger briefing on fresh page load (no existing messages)
if (document.getElementById('chat').children.length === 0) {
  const autoCmd = new Date().getHours() < 12 ? '/morning' : '/evening';
  setTimeout(() => sendText(autoCmd, true), 500);
}
// Close modal on overlay click
document.getElementById('settings-overlay').addEventListener('click', e => {
  if (e.target === document.getElementById('settings-overlay')) closeSettings();
});

// â”€â”€ Init â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// â”€â”€â”€ Service Worker + Web Push â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function registerPush() {
  if (!('serviceWorker' in navigator) || !('PushManager' in window)) return;
  // Only prompt / subscribe once â€” never pester the user on repeat page loads
  if (Notification.permission === 'denied') return;
  try {
    const reg = await navigator.serviceWorker.register('/service-worker.js');
    const keyRes = await fetch('/vapid-public-key');
    if (!keyRes.ok) return;
    const { key } = await keyRes.json();
    let sub = await reg.pushManager.getSubscription();
    if (sub) {
      // Already subscribed â€” only re-send to server if endpoint changed
      const stored = localStorage.getItem('pushEndpoint');
      if (stored === sub.endpoint) return;  // nothing to do
      localStorage.setItem('pushEndpoint', sub.endpoint);
      await fetch('/push-subscribe', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(sub),
      });
      return;
    }
    // No subscription yet â€” only ask if already granted (don't auto-prompt on load)
    if (Notification.permission !== 'granted') return;
    sub = await reg.pushManager.subscribe({
      userVisibleOnly: true,
      applicationServerKey: key,
    });
    localStorage.setItem('pushEndpoint', sub.endpoint);
    await fetch('/push-subscribe', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(sub),
    });
    console.log('âœ… Push notifications registered');
  } catch (e) {
    console.warn('Push registration failed:', e);
  }
}
// Wire the ğŸ”” bell button: toggle notification history panel + request permission if needed
document.getElementById('notifBtn').addEventListener('click', async (ev) => {
  ev.stopPropagation();
  unreadNotifs = 0;
  const badge = document.getElementById('notifBadge');
  badge.style.display = 'none';
  // Toggle the notification history panel
  const panel = document.getElementById('notif-panel');
  const isOpen = panel.style.display !== 'none';
  panel.style.display = isOpen ? 'none' : 'block';
  // If permissions not yet granted, request them
  if (!isOpen && 'Notification' in window && Notification.permission === 'default') {
    const perm = await Notification.requestPermission();
    if (perm === 'granted') {
      showToast('ğŸ”” Enabled', 'Browser notifications on!');
      await registerPush();
    }
  } else if (!isOpen && Notification.permission === 'granted') {
    await registerPush();
  }
});
// Close panel when clicking outside
document.addEventListener('click', (e) => {
  const panel = document.getElementById('notif-panel');
  if (panel && panel.style.display !== 'none' && !panel.contains(e.target) && e.target.id !== 'notifBtn') {
    panel.style.display = 'none';
  }
});
registerPush();
</script>
</body>
</html>
